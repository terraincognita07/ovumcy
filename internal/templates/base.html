{{define "base"}}
<!doctype html>
<html lang="{{.Lang}}" class="h-full">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {{if .MetaDescription}}<meta name="description" content="{{.MetaDescription}}">{{end}}
  <meta name="csrf-token" content="{{.CSRFToken}}">
  <title>{{.Title}}</title>
  <link rel="stylesheet" href="/static/css/tailwind.css?v=20260221-1">
  <script defer src="/static/js/alpine.min.js"></script>
  <script defer src="/static/js/htmx.min.js"></script>
  <script defer src="/static/js/chart-lite.js"></script>
</head>
<body
  data-confirm-cancel="{{t .Messages "confirm.no"}}"
  data-confirm-delete="{{t .Messages "confirm.yes"}}"
  data-request-failed="{{t .Messages "common.error.request_failed"}}">
  <div class="app-shell" x-data="{ mobileMenu: false }">
    <header class="paper-header">
      <div class="container-main flex items-center justify-between py-4">
        <a href="{{if .CurrentUser}}{{if .HideNavigation}}/onboarding{{else}}/dashboard{{end}}{{else}}/login{{end}}" class="brand-mark">{{t .Messages "app.name"}}</a>

        <div class="flex items-center gap-3">
          <div class="lang-switch" role="group" aria-label="{{t .Messages "lang.switch"}}">
            <a href="/lang/ru?next={{urlquery .CurrentPath}}" class="lang-link {{if eq .Lang "ru"}}lang-link-active{{end}}">{{t .Messages "lang.ru"}}</a>
            <a href="/lang/en?next={{urlquery .CurrentPath}}" class="lang-link {{if eq .Lang "en"}}lang-link-active{{end}}">{{t .Messages "lang.en"}}</a>
          </div>

          {{if and .CurrentUser (not .HideNavigation)}}
          <button type="button" class="menu-toggle sm:hidden" @click="mobileMenu = !mobileMenu">{{t .Messages "nav.menu"}}</button>
          {{end}}
        </div>
      </div>

      {{if and .CurrentUser (not .HideNavigation)}}
      <div class="container-main pb-4">
        <nav class="hidden items-center gap-2 sm:flex">
          <a href="/dashboard" class="nav-link {{if isActiveRoute .CurrentPath "/dashboard"}}nav-link-active{{else if isActiveRoute .CurrentPath "/"}}nav-link-active{{end}}">{{t .Messages "nav.dashboard"}}</a>
          <a href="/calendar" class="nav-link {{if isActiveRoute .CurrentPath "/calendar"}}nav-link-active{{end}}">{{t .Messages "nav.calendar"}}</a>
          <a href="/stats" class="nav-link {{if isActiveRoute .CurrentPath "/stats"}}nav-link-active{{end}}">{{t .Messages "nav.stats"}}</a>
          <a href="/settings" class="nav-link {{if isActiveRoute .CurrentPath "/settings"}}nav-link-active{{end}}">{{t .Messages "nav.settings"}}</a>

          <span
            class="role-chip"
            aria-label="{{t .Messages "nav.current_user"}}"
            title="{{userIdentity .CurrentUser}}"
            style="text-transform: none; letter-spacing: 0.01em; max-width: 16rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{userIdentity .CurrentUser}}</span>
          <span class="role-chip" aria-label="{{t .Messages "nav.current_role"}}">âš™ {{roleLabel .Messages .CurrentUser.Role}}</span>

          <form action="/api/auth/logout" method="post" class="ml-1" data-confirm="{{t .Messages "auth.confirm_logout"}}" data-confirm-accept="{{t .Messages "nav.logout"}}">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <button type="submit" class="btn-soft">{{t .Messages "nav.logout"}}</button>
          </form>
        </nav>

        <nav x-show="mobileMenu" x-transition class="mt-2 space-y-2 sm:hidden">
          <p class="journal-muted px-3 pt-1 text-xs">{{t .Messages "nav.current_user"}}: {{userIdentity .CurrentUser}}</p>
          <p class="journal-muted px-3 text-xs">{{t .Messages "nav.current_role"}}: {{roleLabel .Messages .CurrentUser.Role}}</p>
          <a href="/dashboard" class="nav-link block {{if isActiveRoute .CurrentPath "/dashboard"}}nav-link-active{{else if isActiveRoute .CurrentPath "/"}}nav-link-active{{end}}">{{t .Messages "nav.dashboard"}}</a>
          <a href="/calendar" class="nav-link block {{if isActiveRoute .CurrentPath "/calendar"}}nav-link-active{{end}}">{{t .Messages "nav.calendar"}}</a>
          <a href="/stats" class="nav-link block {{if isActiveRoute .CurrentPath "/stats"}}nav-link-active{{end}}">{{t .Messages "nav.stats"}}</a>
          <a href="/settings" class="nav-link block {{if isActiveRoute .CurrentPath "/settings"}}nav-link-active{{end}}">{{t .Messages "nav.settings"}}</a>
          <form action="/api/auth/logout" method="post" data-confirm="{{t .Messages "auth.confirm_logout"}}" data-confirm-accept="{{t .Messages "nav.logout"}}">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
            <button type="submit" class="btn-soft w-full">{{t .Messages "nav.logout"}}</button>
          </form>
        </nav>
      </div>
      {{end}}
    </header>

    <main class="container-main py-8 sm:py-10">
      {{template "content" .}}
    </main>

    {{if not (isActiveRoute .CurrentPath "/privacy")}}
    <footer class="container-main pb-8 pt-2">
      <nav class="flex items-center justify-center">
        <a href="/privacy" class="nav-link text-sm">{{t .Messages "nav.privacy"}}</a>
      </nav>
    </footer>
    {{end}}
  </div>

  <div
    id="confirm-modal"
    class="hidden"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    aria-labelledby="confirm-modal-message"
    style="position: fixed; inset: 0; z-index: 9999; background: rgba(22, 16, 12, 0.52); padding: 1rem;">
    <div style="min-height: 100%; display: flex; align-items: center; justify-content: center;">
      <section class="journal-card" style="width: min(32rem, 100%); padding: 1.25rem;">
        <p id="confirm-modal-message" class="journal-subtitle text-sm"></p>
        <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.5rem;">
          <button id="confirm-modal-cancel" type="button" class="btn-secondary"></button>
          <button id="confirm-modal-accept" type="button" class="btn-danger"></button>
        </div>
      </section>
    </div>
  </div>

  <script>
    (function () {
      var panel = document.querySelector("[data-auth-panel]");
      if (!panel) return;

      var prefersReducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
      if (!prefersReducedMotion) {
        panel.style.opacity = "0";
        panel.style.transform = "translateY(8px)";
        panel.style.transition = "opacity 180ms ease, transform 180ms ease";
        window.requestAnimationFrame(function () {
          panel.style.opacity = "1";
          panel.style.transform = "translateY(0)";
        });
      }

      document.addEventListener("click", function (event) {
        var target = event.target;
        if (!target || !target.closest) return;
        var link = target.closest("a[data-auth-switch]");
        if (!link) return;

        if (event.defaultPrevented || event.button !== 0 || event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
        if (link.getAttribute("target") === "_blank") return;

        var href = (link.getAttribute("href") || "").trim();
        if (!href) return;
        if (prefersReducedMotion) return;

        event.preventDefault();
        panel.style.pointerEvents = "none";
        panel.style.opacity = "0";
        panel.style.transform = "translateY(-6px)";
        window.setTimeout(function () {
          window.location.href = href;
        }, 140);
      });
    })();

    (function () {
      function normalizeLanguage(raw) {
        if (!raw) return "";
        var normalized = String(raw).trim().toLowerCase().replace(/_/g, "-");
        if (!normalized) return "";
        if (normalized.indexOf("-") !== -1) {
          normalized = normalized.split("-")[0];
        }
        if (normalized !== "en" && normalized !== "ru") {
          return "";
        }
        return normalized;
      }

      function readCookie(name) {
        var cookies = document.cookie ? document.cookie.split(";") : [];
        for (var i = 0; i < cookies.length; i++) {
          var part = cookies[i].trim();
          if (part.indexOf(name + "=") !== 0) continue;
          return decodeURIComponent(part.substring(name.length + 1));
        }
        return "";
      }

      function languageFromHref(href) {
        if (!href) return "";
        var match = href.match(/\/lang\/([^/?#]+)/i);
        if (!match || !match[1]) return "";
        return match[1];
      }

      function withCurrentNextPath(href) {
        if (!href) return href;
        try {
          var url = new URL(href, window.location.origin);
          var nextPath = window.location.pathname + window.location.search;
          url.searchParams.set("next", nextPath);
          return url.pathname + url.search + url.hash;
        } catch (_) {
          return href;
        }
      }

      function syncLanguageLinksNextPath() {
        var links = document.querySelectorAll("a.lang-link");
        for (var index = 0; index < links.length; index++) {
          var link = links[index];
          var updatedHref = withCurrentNextPath(link.getAttribute("href"));
          if (updatedHref) {
            link.setAttribute("href", updatedHref);
          }
        }
      }

      function applyHTMLLanguage(raw) {
        var lang = normalizeLanguage(raw);
        if (!lang) return;
        document.documentElement.setAttribute("lang", lang);
      }

      applyHTMLLanguage(readCookie("lume_lang") || document.documentElement.getAttribute("lang"));
      syncLanguageLinksNextPath();

      document.addEventListener("click", function (event) {
        var target = event.target;
        if (!target || !target.closest) return;
        var link = target.closest("a.lang-link");
        if (!link) return;
        var updatedHref = withCurrentNextPath(link.getAttribute("href"));
        if (updatedHref) {
          link.setAttribute("href", updatedHref);
        }
        applyHTMLLanguage(languageFromHref(updatedHref || link.getAttribute("href")));
      });
    })();

    (function () {
      function toggleLabel(button, isVisible) {
        var showLabel = button.getAttribute("data-show-label") || "Show password";
        var hideLabel = button.getAttribute("data-hide-label") || "Hide password";
        button.setAttribute("aria-label", isVisible ? hideLabel : showLabel);
        button.textContent = isVisible ? "ðŸ™ˆ" : "ðŸ‘";
      }

      function attachPasswordToggles(root) {
        var scope = root && root.querySelectorAll ? root : document;
        var buttons = scope.querySelectorAll("[data-password-toggle]");
        for (var index = 0; index < buttons.length; index++) {
          var button = buttons[index];
          if (button.dataset.passwordToggleBound === "1") continue;

          var field = button.parentElement ? button.parentElement.querySelector("input[type='password'], input[type='text']") : null;
          if (!field) continue;

          button.dataset.passwordToggleBound = "1";
          toggleLabel(button, field.type === "text");

          button.addEventListener("click", (function (input, toggleButton) {
            return function () {
              var reveal = input.type === "password";
              input.type = reveal ? "text" : "password";
              toggleLabel(toggleButton, reveal);
            };
          })(field, button));
        }
      }

      attachPasswordToggles(document);
      document.body.addEventListener("htmx:afterSwap", function (event) {
        var target = event && event.detail ? event.detail.target : null;
        attachPasswordToggles(target || document);
      });
    })();

    (function () {
      var modal = document.getElementById("confirm-modal");
      var messageNode = document.getElementById("confirm-modal-message");
      var cancelButton = document.getElementById("confirm-modal-cancel");
      var acceptButton = document.getElementById("confirm-modal-accept");
      if (!modal || !messageNode || !cancelButton || !acceptButton) return;

      var pendingResolve = null;

      function closeConfirm(accepted) {
        if (!pendingResolve) return;
        var resolve = pendingResolve;
        pendingResolve = null;
        modal.classList.add("hidden");
        modal.setAttribute("aria-hidden", "true");
        resolve(accepted);
      }

      function openConfirm(question, acceptLabel) {
        if (pendingResolve) {
          pendingResolve(false);
          pendingResolve = null;
        }

        messageNode.textContent = question;
        cancelButton.textContent = document.body.getAttribute("data-confirm-cancel") || "Cancel";
        acceptButton.textContent = acceptLabel || document.body.getAttribute("data-confirm-delete") || "Delete";
        modal.classList.remove("hidden");
        modal.setAttribute("aria-hidden", "false");
        cancelButton.focus();

        return new Promise(function (resolve) {
          pendingResolve = resolve;
        });
      }

      cancelButton.addEventListener("click", function () {
        closeConfirm(false);
      });

      acceptButton.addEventListener("click", function () {
        closeConfirm(true);
      });

      modal.addEventListener("click", function (event) {
        if (event.target === modal) {
          closeConfirm(false);
        }
      });

      document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          closeConfirm(false);
        }
      });

      document.body.addEventListener("htmx:confirm", function (event) {
        if (!event || !event.detail || !event.detail.question) return;
        var source = event.detail.elt || event.target;
        if (!source || !source.getAttribute) return;
        var acceptLabel = source.getAttribute("data-confirm-accept") || "";
        event.preventDefault();
        openConfirm(event.detail.question, acceptLabel).then(function (confirmed) {
          if (confirmed) {
            event.detail.issueRequest(true);
          }
        });
      });

      document.addEventListener("submit", function (event) {
        var form = event.target;
        if (!form || !form.matches || !form.matches("form[data-confirm]")) return;
        if (form.dataset.confirmBypass === "1") {
          form.dataset.confirmBypass = "";
          return;
        }

        event.preventDefault();
        openConfirm(form.getAttribute("data-confirm") || "", form.getAttribute("data-confirm-accept") || "").then(function (confirmed) {
          if (!confirmed) return;
          form.dataset.confirmBypass = "1";
          if (typeof form.requestSubmit === "function") {
            form.requestSubmit();
            return;
          }
          form.submit();
        });
      });
    })();

    (function () {
      var stack = null;

      function getStack() {
        if (stack) return stack;
        stack = document.createElement("div");
        stack.style.position = "fixed";
        stack.style.right = "1rem";
        stack.style.bottom = "1rem";
        stack.style.zIndex = "10000";
        stack.style.display = "flex";
        stack.style.flexDirection = "column";
        stack.style.gap = "0.5rem";
        stack.style.maxWidth = "22rem";
        document.body.appendChild(stack);
        return stack;
      }

      function showToast(message, kind) {
        if (!message) return;
        var container = getStack();
        var toast = document.createElement("div");
        toast.className = (kind === "error" ? "status-error" : "status-ok") + " reveal";
        toast.textContent = message;
        container.appendChild(toast);
        window.setTimeout(function () {
          toast.style.opacity = "0";
          toast.style.transform = "translateY(4px)";
          toast.style.transition = "opacity 0.2s ease, transform 0.2s ease";
          window.setTimeout(function () {
            toast.remove();
          }, 220);
        }, 2200);
      }

      window.showToast = showToast;
    })();

    document.body.addEventListener("htmx:configRequest", function (event) {
      var tokenMeta = document.querySelector('meta[name="csrf-token"]');
      if (!tokenMeta) return;
      var token = tokenMeta.getAttribute("content");
      if (!token) return;
      event.detail.parameters = event.detail.parameters || {};
      event.detail.parameters.csrf_token = token;
      event.detail.headers = event.detail.headers || {};
      event.detail.headers["X-CSRF-Token"] = token;
    });

    document.body.addEventListener("htmx:beforeRequest", function (event) {
      var form = event.target.closest("form[data-save-feedback]");
      if (!form) return;
      var button = form.querySelector('[data-save-button]');
      if (!button) return;
      button.disabled = true;
      button.setAttribute("aria-busy", "true");
      button.classList.add("btn-loading");
    });

    document.body.addEventListener("htmx:afterRequest", function (event) {
      var form = event.target.closest("form[data-save-feedback]");
      if (!form) return;
      var button = form.querySelector('[data-save-button]');
      if (!button) return;
      button.disabled = false;
      button.removeAttribute("aria-busy");
      button.classList.remove("btn-loading");
    });

    document.body.addEventListener("htmx:afterSwap", function (event) {
      var target = event.detail.target;
      if (!target || !target.classList) return;
      if (!target.classList.contains("save-status")) return;
      var successNode = target.querySelector(".status-ok");
      if (!successNode) return;

      var dayEditor = document.getElementById("day-editor");
      var form = target.closest("form[data-save-feedback]");
      if (dayEditor && form && form.closest("#day-editor")) {
        if (window.htmx && typeof window.htmx.trigger === "function") {
          window.htmx.trigger(document.body, "calendar-day-updated");
        }
        var postPath = form.getAttribute("hx-post") || "";
        var match = postPath.match(/\/api\/days\/(\d{4}-\d{2}-\d{2})$/);
        if (match) {
          htmx.ajax("GET", "/calendar/day/" + match[1], { target: "#day-editor", swap: "innerHTML" });
        }
      }

      window.setTimeout(function () {
        if (target.querySelector(".status-ok")) {
          target.innerHTML = "";
        }
      }, 2000);
    });

    document.body.addEventListener("htmx:responseError", function (event) {
      var target = event && event.detail ? event.detail.target : null;
      if (!target || !target.classList || !target.classList.contains("save-status")) return;

      var xhr = event.detail.xhr;
      var responseText = xhr && typeof xhr.responseText === "string" ? xhr.responseText : "";
      if (responseText && responseText.indexOf("status-error") !== -1) {
        target.innerHTML = responseText;
        return;
      }

      var fallback = document.body.getAttribute("data-request-failed") || "Request failed. Please try again.";
      target.innerHTML = '<div class="status-error">' + fallback + '</div>';
    });
  </script>
</body>
</html>
{{end}}
