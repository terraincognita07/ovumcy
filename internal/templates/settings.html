{{define "content"}}
<section class="space-y-6">
  <div>
    <h1 class="journal-title">{{t .Messages "settings.title"}}</h1>
    <p class="journal-muted mt-2">{{t .Messages "settings.subtitle"}}</p>
  </div>

  {{if .SuccessKey}}
  <div class="status-ok flex items-center gap-2"><span aria-hidden="true">‚úÖ</span><span>{{t .Messages .SuccessKey}}</span></div>
  {{end}}

  {{if .ErrorKey}}
  <div class="status-error flex items-center gap-2"><span aria-hidden="true">‚ö†Ô∏è</span><span>{{t .Messages .ErrorKey}}</span></div>
  {{end}}

  <section class="journal-card p-5 sm:p-6">
    <h2 class="journal-subtitle">üë§ {{t .Messages "settings.profile.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.profile.subtitle"}}</p>

    <form action="/api/settings/profile" method="post" class="mt-5 space-y-4">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      <label class="field-label" for="settings-display-name">{{t .Messages "settings.profile.display_name"}}</label>
      <input
        id="settings-display-name"
        type="text"
        name="display_name"
        value="{{.CurrentUser.DisplayName}}"
        maxlength="64"
        autocomplete="nickname"
        class="input-field">
      <p class="journal-muted text-xs">{{t .Messages "settings.profile.display_name_hint"}}</p>

      <label class="field-label" for="settings-profile-email">{{t .Messages "settings.profile.email"}}</label>
      <input id="settings-profile-email" type="email" value="{{.CurrentUser.Email}}" readonly class="input-field" style="opacity: 0.75; cursor: default;">

      <button type="submit" class="btn-secondary">{{t .Messages "settings.profile.submit"}}</button>
    </form>
  </section>

  {{if eq .CurrentUser.Role "owner"}}
  <section class="journal-card p-5 sm:p-6" x-data="{ cycleLength: {{.CycleLength}}, periodLength: {{.PeriodLength}}, autoPeriodFill: {{if .AutoPeriodFill}}true{{else}}false{{end}} }">
    <h2 class="journal-subtitle">üóìÔ∏è {{t .Messages "settings.cycle.title"}}</h2>

    <form
      action="/settings/cycle"
      method="post"
      hx-post="/settings/cycle"
      hx-target="#settings-cycle-status"
      hx-swap="innerHTML"
      class="mt-5 space-y-6"
      data-save-feedback>
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      <div class="space-y-2">
        <div class="flex items-center justify-between gap-2">
          <label class="field-label" for="settings-cycle-length">{{t .Messages "settings.cycle.cycle_length"}}</label>
          <span class="journal-muted text-sm"><span x-text="cycleLength"></span> {{t .Messages "common.days_short"}}</span>
        </div>
        <input
          id="settings-cycle-length"
          type="range"
          min="15"
          max="90"
          name="cycle_length"
          value="{{.CycleLength}}"
          x-model.number="cycleLength"
          class="w-full range-field">
        <p class="warning-amber text-sm" x-cloak x-show="cycleLength > 45">{{t .Messages "settings.cycle.cycle_warning"}}</p>
      </div>

      <div class="space-y-2">
        <div class="flex items-center justify-between gap-2">
          <label class="field-label" for="settings-period-length">{{t .Messages "settings.cycle.period_length"}}</label>
          <span class="journal-muted text-sm"><span x-text="periodLength"></span> {{t .Messages "common.days_short"}}</span>
        </div>
        <input
          id="settings-period-length"
          type="range"
          min="1"
          max="10"
          name="period_length"
          value="{{.PeriodLength}}"
          x-model.number="periodLength"
          class="w-full range-field">
        <p class="journal-muted text-sm" x-cloak x-show="periodLength > 8">{{t .Messages "settings.cycle.period_warning"}}</p>
      </div>

      <div class="space-y-2">
        <label class="period-toggle">
          <input type="checkbox" name="auto_period_fill" value="true" x-model="autoPeriodFill" {{if .AutoPeriodFill}}checked{{end}}>
          <span>ü©∏ {{t .Messages "settings.cycle.auto_period_fill"}}</span>
        </label>
        <p class="journal-muted text-sm">{{t .Messages "settings.cycle.auto_period_fill_hint"}}</p>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <button type="submit" class="btn-primary" data-save-button data-saving-label="{{t .Messages "common.saving"}}">{{t .Messages "settings.cycle.save"}}</button>
      </div>
      <div id="settings-cycle-status" class="save-status text-sm"></div>
    </form>
  </section>
  {{end}}

  <section class="journal-card p-5 sm:p-6" id="settings-change-password">
    <h2 class="journal-subtitle">üîí {{t .Messages "settings.change_password.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.change_password.subtitle"}}</p>

    <form
      action="/api/settings/change-password"
      method="post"
      hx-post="/api/settings/change-password"
      hx-target="#settings-change-password-status"
      hx-swap="innerHTML"
      class="mt-5 space-y-4"
      data-save-feedback>
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      {{if .ChangePasswordErrorKey}}
      <div class="status-error flex items-center gap-2" aria-live="polite"><span aria-hidden="true">‚ö†Ô∏è</span><span>{{t .Messages .ChangePasswordErrorKey}}</span></div>
      {{end}}

      <label class="field-label" for="settings-current-password">{{t .Messages "settings.current_password"}}</label>
      <div class="password-field">
        <input id="settings-current-password" type="password" name="current_password" required autocomplete="current-password" class="input-field input-with-toggle">
        <button
          type="button"
          class="password-toggle-btn"
          data-password-toggle
          data-show-label="{{t .Messages "auth.show_password"}}"
          data-hide-label="{{t .Messages "auth.hide_password"}}"
          aria-label="{{t .Messages "auth.show_password"}}">üëÅ</button>
      </div>

      <label class="field-label" for="settings-new-password">{{t .Messages "auth.new_password"}}</label>
      <div class="password-field">
        <input id="settings-new-password" type="password" name="new_password" required autocomplete="new-password" class="input-field input-with-toggle">
        <button
          type="button"
          class="password-toggle-btn"
          data-password-toggle
          data-show-label="{{t .Messages "auth.show_password"}}"
          data-hide-label="{{t .Messages "auth.hide_password"}}"
          aria-label="{{t .Messages "auth.show_password"}}">üëÅ</button>
      </div>

      <label class="field-label" for="settings-confirm-password">{{t .Messages "auth.confirm_password"}}</label>
      <div class="password-field">
        <input id="settings-confirm-password" type="password" name="confirm_password" required autocomplete="new-password" class="input-field input-with-toggle">
        <button
          type="button"
          class="password-toggle-btn"
          data-password-toggle
          data-show-label="{{t .Messages "auth.show_password"}}"
          data-hide-label="{{t .Messages "auth.hide_password"}}"
          aria-label="{{t .Messages "auth.show_password"}}">üëÅ</button>
      </div>
      <p class="journal-muted text-xs">{{t .Messages "auth.password_requirements"}}</p>

      <button type="submit" class="btn-primary" data-save-button data-saving-label="{{t .Messages "common.saving"}}">{{t .Messages "settings.change_password.submit"}}</button>
      <div id="settings-change-password-status" class="save-status text-sm"></div>
    </form>
  </section>

  <section class="journal-card p-5 sm:p-6">
    <h2 class="journal-subtitle">üîë {{t .Messages "settings.recovery_code.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.recovery_code.subtitle"}}</p>

    <form
      action="/api/settings/regenerate-recovery-code"
      method="post"
      class="mt-5"
      data-confirm="{{t .Messages "settings.confirm_regenerate_recovery_code"}}"
      data-confirm-accept="{{t .Messages "settings.recovery_code.submit"}}">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <button type="submit" class="btn-secondary">{{t .Messages "settings.recovery_code.submit"}}</button>
    </form>

    {{if .GeneratedRecoveryCode}}
    <div class="mt-5 space-y-3">
      <p class="field-label">{{t .Messages "settings.recovery_code.generated_title"}}</p>
      <div class="recovery-code-box">{{.GeneratedRecoveryCode}}</div>
      <p class="journal-muted text-xs">{{t .Messages "settings.recovery_code.generated_subtitle"}}</p>
    </div>
    {{end}}
  </section>

  {{if eq .CurrentUser.Role "owner"}}
  <section
    class="journal-card p-5 sm:p-6 space-y-3"
    data-export-section
    data-export-min="{{if .HasExportData}}{{.ExportDateFrom}}{{end}}"
    data-export-max="{{if .HasExportData}}{{.ExportDateTo}}{{end}}"
    data-export-success="{{t .Messages "settings.export_success"}}"
    data-export-failed="{{t .Messages "settings.export_failed"}}"
    data-export-invalid-range="{{t .Messages "settings.export_invalid_range"}}"
    data-export-invalid-date="{{t .Messages "settings.export_invalid_date"}}"
    data-export-open-calendar="{{t .Messages "settings.export_open_calendar"}}"
    data-export-jump-title="{{t .Messages "settings.export_jump_title"}}"
    data-export-summary-total-template="{{t .Messages "settings.export_summary_total"}}"
    data-export-summary-range-template="{{t .Messages "settings.export_summary_range"}}"
    data-export-summary-range-empty="{{t .Messages "settings.export_summary_range_empty"}}">
    <h2 class="journal-subtitle">üìä {{t .Messages "settings.export_data"}}</h2>
    <div class="grid gap-3 sm:grid-cols-2">
      <div class="space-y-1">
        <label class="field-label" for="export-from">{{t .Messages "settings.export_from"}}</label>
        <input
          id="export-from"
          type="text"
          inputmode="numeric"
          autocomplete="off"
          spellcheck="false"
          placeholder="{{t .Messages "settings.export_date_placeholder"}}"
          data-export-from
          class="input-field w-full"
          {{if .HasExportData}}value="{{.ExportDateFrom}}"{{end}}>
      </div>
      <div class="space-y-1">
        <label class="field-label" for="export-to">{{t .Messages "settings.export_to"}}</label>
        <input
          id="export-to"
          type="text"
          inputmode="numeric"
          autocomplete="off"
          spellcheck="false"
          placeholder="{{t .Messages "settings.export_date_placeholder"}}"
          data-export-to
          class="input-field w-full"
          {{if .HasExportData}}value="{{.ExportDateTo}}"{{end}}>
      </div>
    </div>
    <div class="flex flex-wrap items-center gap-2" data-export-presets>
      <span class="journal-muted text-sm">{{t .Messages "settings.export_presets"}}:</span>
      <button type="button" class="btn-soft text-sm" data-export-preset="all">{{t .Messages "settings.export_preset_all"}}</button>
      <button type="button" class="btn-soft text-sm" data-export-preset="30">{{t .Messages "settings.export_preset_30"}}</button>
      <button type="button" class="btn-soft text-sm" data-export-preset="90">{{t .Messages "settings.export_preset_90"}}</button>
      <button type="button" class="btn-soft text-sm" data-export-preset="365">{{t .Messages "settings.export_preset_365"}}</button>
    </div>
    <div class="hidden journal-card p-4 space-y-3" data-export-calendar-panel>
      <div class="flex items-center justify-between gap-2">
        <button type="button" class="btn-secondary" data-export-calendar-prev aria-label="{{t .Messages "settings.export_prev_month"}}">‚Üê</button>
        <button
          type="button"
          class="btn-soft text-sm"
          style="flex: 1;"
          data-export-calendar-title-toggle
          aria-label="{{t .Messages "settings.export_jump_title"}}">
          <span class="field-label text-center" data-export-calendar-title></span>
        </button>
        <button type="button" class="btn-secondary" data-export-calendar-next aria-label="{{t .Messages "settings.export_next_month"}}">‚Üí</button>
      </div>
      <div class="hidden flex items-center gap-2" data-export-calendar-jump>
        <select class="input-field w-full" data-export-calendar-month aria-label="{{t .Messages "settings.export_month"}}"></select>
        <input
          type="number"
          class="input-field w-full"
          data-export-calendar-year
          min="1900"
          max="2200"
          step="1"
          aria-label="{{t .Messages "settings.export_year"}}">
        <button type="button" class="btn-secondary" data-export-calendar-apply>{{t .Messages "settings.export_apply"}}</button>
      </div>
      <p class="journal-muted text-sm" data-export-calendar-active></p>
      <div class="grid grid-cols-7 gap-1 text-center text-xs journal-muted" data-export-calendar-weekdays></div>
      <div class="grid grid-cols-7 gap-1" data-export-calendar-days></div>
      <div class="flex justify-end">
        <button type="button" class="btn-secondary" data-export-calendar-close>{{t .Messages "settings.export_close_calendar"}}</button>
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="/api/export/csv" data-export-link data-export-type="csv" class="btn-secondary inline-flex items-center justify-center"><span class="mr-2" aria-hidden="true">üìä</span><span>{{t .Messages "settings.export_csv"}}</span></a>
      <a href="/api/export/json" data-export-link data-export-type="json" class="btn-secondary inline-flex items-center justify-center"><span class="mr-2" aria-hidden="true">üßæ</span><span>{{t .Messages "settings.export_json"}}</span></a>
    </div>
    <p class="journal-muted text-sm" data-export-summary-total>{{printf (t .Messages "settings.export_summary_total") .ExportTotalEntries}}</p>
    <p class="journal-muted text-sm" data-export-summary-range>
      {{if .HasExportData}}{{printf (t .Messages "settings.export_summary_range") .ExportDateFrom .ExportDateTo}}{{else}}{{t .Messages "settings.export_summary_range_empty"}}{{end}}
    </p>
    <p class="journal-muted mt-3 text-xs">{{t .Messages "settings.export_data_hint"}}</p>
  </section>
  {{end}}

  {{if eq .CurrentUser.Role "owner"}}
  <section class="journal-card border border-[rgba(196,146,74,0.38)] bg-[rgba(255,247,228,0.62)] p-5 sm:p-6">
    <h2 class="journal-subtitle">üßπ {{t .Messages "settings.clear_data.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.clear_data.subtitle"}}</p>

    <form
      action="/api/settings/clear-data"
      method="post"
      class="mt-5"
      data-confirm="{{t .Messages "settings.confirm_clear_data"}}"
      data-confirm-accept="{{t .Messages "settings.clear_data.submit"}}">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <button type="submit" class="btn-warning">{{t .Messages "settings.clear_data.submit"}}</button>
    </form>
  </section>
  {{end}}

  <section class="journal-card border border-red-200 p-5 sm:p-6">
    <h2 class="journal-subtitle text-red-700">‚ö†Ô∏è {{t .Messages "settings.danger_zone.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.danger_zone.subtitle"}}</p>

    <form
      hx-delete="/api/settings/delete-account"
      hx-target="#delete-account-feedback"
      hx-swap="innerHTML"
      hx-confirm="{{t .Messages "settings.confirm_delete_account"}}"
      data-confirm-accept="{{t .Messages "settings.delete_account.submit"}}"
      class="mt-5 space-y-4">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      <label class="field-label" for="settings-delete-password">{{t .Messages "settings.delete_account.password"}}</label>
      <div class="password-field">
        <input id="settings-delete-password" type="password" name="password" required autocomplete="current-password" class="input-field input-with-toggle">
        <button
          type="button"
          class="password-toggle-btn"
          data-password-toggle
          data-show-label="{{t .Messages "auth.show_password"}}"
          data-hide-label="{{t .Messages "auth.hide_password"}}"
          aria-label="{{t .Messages "auth.show_password"}}">üëÅ</button>
      </div>

      <button type="submit" class="btn-danger">{{t .Messages "settings.delete_account.submit"}}</button>
      <div id="delete-account-feedback" class="save-status text-sm"></div>
    </form>
  </section>
</section>
{{if eq .CurrentUser.Role "owner"}}
<script>
  (function () {
    var section = document.querySelector("[data-export-section]");
    if (!section) return;

    var rawMinDate = section.getAttribute("data-export-min") || "";
    var rawMaxDate = section.getAttribute("data-export-max") || "";
    var successMessage = section.getAttribute("data-export-success") || "Data exported successfully";
    var failedMessage = section.getAttribute("data-export-failed") || "Failed to export data";
    var invalidRangeMessage = section.getAttribute("data-export-invalid-range") || "End date must be on or after start date";
    var invalidDateMessage = section.getAttribute("data-export-invalid-date") || "Use YYYY-MM-DD";
    var openCalendarLabel = section.getAttribute("data-export-open-calendar") || "Open calendar";
    var jumpTitle = section.getAttribute("data-export-jump-title") || "Choose month and year";
    var summaryTotalTemplate = section.getAttribute("data-export-summary-total-template") || "Total entries: %d";
    var summaryRangeTemplate = section.getAttribute("data-export-summary-range-template") || "Date range: %s to %s";
    var summaryRangeEmpty = section.getAttribute("data-export-summary-range-empty") || "Date range: -";
    var links = section.querySelectorAll("a[data-export-link]");
    var presetButtons = section.querySelectorAll("button[data-export-preset]");
    var fromInput = section.querySelector("input[data-export-from]");
    var toInput = section.querySelector("input[data-export-to]");
    var summaryTotalNode = section.querySelector("[data-export-summary-total]");
    var summaryRangeNode = section.querySelector("[data-export-summary-range]");
    var calendarPanel = section.querySelector("[data-export-calendar-panel]");
    var calendarTitle = section.querySelector("[data-export-calendar-title]");
    var calendarTitleToggle = section.querySelector("[data-export-calendar-title-toggle]");
    var calendarActive = section.querySelector("[data-export-calendar-active]");
    var calendarJump = section.querySelector("[data-export-calendar-jump]");
    var calendarMonth = section.querySelector("[data-export-calendar-month]");
    var calendarYear = section.querySelector("[data-export-calendar-year]");
    var calendarApply = section.querySelector("[data-export-calendar-apply]");
    var calendarWeekdays = section.querySelector("[data-export-calendar-weekdays]");
    var calendarDays = section.querySelector("[data-export-calendar-days]");
    var calendarPrev = section.querySelector("[data-export-calendar-prev]");
    var calendarNext = section.querySelector("[data-export-calendar-next]");
    var calendarClose = section.querySelector("[data-export-calendar-close]");
    var locale = (document.documentElement.getAttribute("lang") || "").toLowerCase().indexOf("ru") === 0 ? "ru-RU" : "en-US";
    var monthFormatter = new Intl.DateTimeFormat(locale, { month: "long", year: "numeric" });
    var weekdayFormatter = new Intl.DateTimeFormat(locale, { weekday: "short" });
    var monthNameFormatter = new Intl.DateTimeFormat(locale, { month: "long" });
    var monthNames = [];
    var activeInput = null;
    var visibleMonth = null;
    var summaryTimer = 0;
    var summaryRequestID = 0;
    if (!links.length || !fromInput || !toInput) return;

    for (var monthIndex = 0; monthIndex < 12; monthIndex++) {
      monthNames.push(monthNameFormatter.format(new Date(2024, monthIndex, 1)));
    }

    if (calendarMonth) {
      calendarMonth.innerHTML = "";
      for (var optionMonth = 0; optionMonth < 12; optionMonth++) {
        var option = document.createElement("option");
        option.value = String(optionMonth);
        option.textContent = monthNames[optionMonth];
        calendarMonth.appendChild(option);
      }
    }

    function padNumber(value) {
      if (value < 10) {
        return "0" + String(value);
      }
      return String(value);
    }

    function formatISODate(value) {
      if (!value) return "";
      return [
        String(value.getFullYear()),
        padNumber(value.getMonth() + 1),
        padNumber(value.getDate())
      ].join("-");
    }

    function parseISODate(raw) {
      var normalized = String(raw || "").trim();
      if (!normalized) return null;
      var match = /^(\d{4})-(\d{2})-(\d{2})$/.exec(normalized);
      if (!match) return null;

      var year = Number(match[1]);
      var month = Number(match[2]) - 1;
      var day = Number(match[3]);
      var parsed = new Date(year, month, day);
      if (
        parsed.getFullYear() !== year ||
        parsed.getMonth() !== month ||
        parsed.getDate() !== day
      ) {
        return null;
      }
      return parsed;
    }

    function sanitizeDateInputValue(input) {
      if (!input) return;
      var digits = String(input.value || "").replace(/\D/g, "").slice(0, 8);
      var year = digits.slice(0, 4);
      var month = digits.slice(4, 6);
      var day = digits.slice(6, 8);

      if (month.length === 2) {
        var monthNumber = Number(month);
        if (monthNumber < 1) {
          month = "01";
        } else if (monthNumber > 12) {
          month = "12";
        } else {
          month = monthNumber < 10 ? "0" + String(monthNumber) : String(monthNumber);
        }
      }

      if (day.length === 2) {
        var dayNumber = Number(day);
        if (dayNumber < 1) {
          day = "01";
        } else if (dayNumber > 31) {
          day = "31";
        } else {
          day = dayNumber < 10 ? "0" + String(dayNumber) : String(dayNumber);
        }
      }

      var normalized = year;
      if (month.length > 0) {
        normalized += "-" + month;
      }
      if (day.length > 0) {
        normalized += "-" + day;
      }

      if (normalized !== input.value) {
        input.value = normalized;
      }
    }

    function formatTemplate(template, values) {
      var index = 0;
      return String(template || "").replace(/%[sd]/g, function () {
        var value = index < values.length ? values[index] : "";
        index += 1;
        return String(value);
      });
    }

    function cloneDate(value) {
      return new Date(value.getFullYear(), value.getMonth(), value.getDate());
    }

    function dateKey(value) {
      return Number(formatISODate(value).replace(/-/g, ""));
    }

    function toMonthStart(value) {
      return new Date(value.getFullYear(), value.getMonth(), 1);
    }

    function monthEnd(value) {
      return new Date(value.getFullYear(), value.getMonth() + 1, 0);
    }

    var minBound = parseISODate(rawMinDate);
    var maxBound = parseISODate(rawMaxDate);
    var hasBounds = !!(minBound && maxBound && dateKey(minBound) <= dateKey(maxBound));

    function isSameDay(left, right) {
      if (!left || !right) return false;
      return dateKey(left) === dateKey(right);
    }

    function isWithinBounds(value) {
      if (!hasBounds || !value) return true;
      var key = dateKey(value);
      return key >= dateKey(minBound) && key <= dateKey(maxBound);
    }

    function clampToBounds(value) {
      if (!hasBounds || !value) return value;
      var key = dateKey(value);
      if (key < dateKey(minBound)) {
        return cloneDate(minBound);
      }
      if (key > dateKey(maxBound)) {
        return cloneDate(maxBound);
      }
      return value;
    }

    function monthIntersectsBounds(monthValue) {
      if (!hasBounds) return true;
      var start = toMonthStart(monthValue);
      var end = monthEnd(monthValue);
      return dateKey(end) >= dateKey(minBound) && dateKey(start) <= dateKey(maxBound);
    }

    function clampMonthToBounds(monthValue) {
      if (!monthValue) {
        return hasBounds ? toMonthStart(maxBound) : toMonthStart(new Date());
      }
      var normalized = toMonthStart(monthValue);
      if (!hasBounds || monthIntersectsBounds(normalized)) {
        return normalized;
      }
      if (dateKey(normalized) < dateKey(toMonthStart(minBound))) {
        return toMonthStart(minBound);
      }
      return toMonthStart(maxBound);
    }

    function inputLabel(input) {
      if (!input || !input.id) return "";
      var label = section.querySelector('label[for="' + input.id + '"]');
      if (!label) return "";
      return String(label.textContent || "").trim();
    }

    function renderWeekdayLabels() {
      if (!calendarWeekdays) return;
      calendarWeekdays.innerHTML = "";

      for (var weekday = 0; weekday < 7; weekday++) {
        var sample = new Date(2023, 0, 1 + weekday);
        var label = weekdayFormatter.format(sample).replace(/\./g, "");
        var cell = document.createElement("span");
        cell.textContent = label;
        calendarWeekdays.appendChild(cell);
      }
    }

    function setButtonDisabled(button, disabled) {
      if (!button) return;
      button.disabled = disabled;
      button.setAttribute("aria-disabled", disabled ? "true" : "false");
    }

    function setExportLinksDisabled(disabled) {
      for (var index = 0; index < links.length; index++) {
        var link = links[index];
        if (disabled) {
          link.style.pointerEvents = "none";
          link.style.opacity = "0.6";
        } else {
          link.style.pointerEvents = "";
          link.style.opacity = "";
        }
        link.setAttribute("aria-disabled", disabled ? "true" : "false");
      }
    }

    function updateSummaryText(totalEntries, hasData, dateFrom, dateTo) {
      if (summaryTotalNode) {
        summaryTotalNode.textContent = formatTemplate(summaryTotalTemplate, [Number(totalEntries) || 0]);
      }
      if (!summaryRangeNode) return;

      if (hasData && dateFrom && dateTo) {
        summaryRangeNode.textContent = formatTemplate(summaryRangeTemplate, [dateFrom, dateTo]);
      } else {
        summaryRangeNode.textContent = summaryRangeEmpty;
      }
    }

    function buildSummaryEndpoint() {
      var url = new URL("/api/export/summary", window.location.origin);
      if (fromInput.value) {
        url.searchParams.set("from", fromInput.value);
      }
      if (toInput.value) {
        url.searchParams.set("to", toInput.value);
      }
      return url.toString();
    }

    function scheduleSummaryRefresh() {
      if (!hasBounds) return;
      if (summaryTimer) {
        window.clearTimeout(summaryTimer);
      }
      summaryTimer = window.setTimeout(function () {
        refreshSummary();
      }, 160);
    }

    async function refreshSummary() {
      if (!hasBounds) return;
      if (!validateExportRange("summary")) return;

      var requestID = ++summaryRequestID;
      var headers = {};
      var currentLang = (document.documentElement.getAttribute("lang") || "").trim();
      if (currentLang) {
        headers["Accept-Language"] = currentLang;
      }

      try {
        var response = await fetch(buildSummaryEndpoint(), {
          credentials: "same-origin",
          headers: headers
        });
        if (!response.ok) {
          throw new Error("summary_failed");
        }
        var payload = await response.json();
        if (requestID != summaryRequestID) return;
        updateSummaryText(payload.total_entries, payload.has_data, payload.date_from, payload.date_to);
      } catch (_) {
        // Keep previous summary values if refresh fails.
      }
    }

    function syncJumpControls() {
      if (!visibleMonth) return;

      if (calendarYear) {
        if (hasBounds) {
          calendarYear.min = String(minBound.getFullYear());
          calendarYear.max = String(maxBound.getFullYear());
        } else {
          calendarYear.min = "1900";
          calendarYear.max = "2200";
        }
        calendarYear.value = String(visibleMonth.getFullYear());
      }

      if (calendarMonth) {
        calendarMonth.value = String(visibleMonth.getMonth());
        var jumpYear = visibleMonth.getFullYear();
        for (var index = 0; index < calendarMonth.options.length; index++) {
          var option = calendarMonth.options[index];
          option.disabled = hasBounds && !monthIntersectsBounds(new Date(jumpYear, index, 1));
        }
      }

      if (calendarApply && calendarMonth && calendarYear) {
        var yearValue = Number(calendarYear.value);
        var monthValue = Number(calendarMonth.value);
        var candidate = new Date(yearValue, monthValue, 1);
        var invalidCandidate = Number.isNaN(yearValue) || Number.isNaN(monthValue);
        setButtonDisabled(calendarApply, invalidCandidate || (hasBounds && !monthIntersectsBounds(candidate)));
      }
    }

    function updateNavButtons() {
      if (!visibleMonth) return;
      if (calendarPrev) {
        var previousMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth() - 1, 1);
        setButtonDisabled(calendarPrev, hasBounds && !monthIntersectsBounds(previousMonth));
      }
      if (calendarNext) {
        var nextMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth() + 1, 1);
        setButtonDisabled(calendarNext, hasBounds && !monthIntersectsBounds(nextMonth));
      }
    }

    function computePresetRange(rawPreset) {
      if (!hasBounds) return null;
      var preset = String(rawPreset || "").trim().toLowerCase();
      if (preset == "all") {
        return { from: cloneDate(minBound), to: cloneDate(maxBound) };
      }
      var days = Number(preset);
      if (!Number.isFinite(days) || days < 1) return null;

      var toDate = cloneDate(maxBound);
      var fromDate = new Date(toDate.getFullYear(), toDate.getMonth(), toDate.getDate() - days + 1);
      return { from: fromDate, to: toDate };
    }

    function updatePresetState() {
      if (!presetButtons.length) return;
      var fromDate = parseISODate(fromInput.value);
      var toDate = parseISODate(toInput.value);

      for (var index = 0; index < presetButtons.length; index++) {
        var button = presetButtons[index];
        var presetValue = button.getAttribute("data-export-preset") || "";
        var range = computePresetRange(presetValue);
        var active = !!(range && fromDate && toDate && isSameDay(fromDate, range.from) && isSameDay(toDate, range.to));

        setButtonDisabled(button, !hasBounds);
        button.classList.toggle("btn-primary", active);
        button.classList.toggle("btn-soft", !active);
      }
    }

    function parseAndNormalizeInput(input) {
      sanitizeDateInputValue(input);
      var raw = String(input.value || "").trim();
      input.value = raw;

      if (!raw) {
        input.setCustomValidity("");
        return { ok: true, date: null };
      }

      var parsed = parseISODate(raw);
      if (!parsed) {
        input.setCustomValidity(invalidDateMessage);
        return { ok: false, date: null };
      }

      input.value = formatISODate(parsed);
      input.setCustomValidity("");
      return { ok: true, date: parsed };
    }

    function validateExportRange(changedSide) {
      var fromResult = parseAndNormalizeInput(fromInput);
      var toResult = parseAndNormalizeInput(toInput);
      if (!fromResult.ok || !toResult.ok) {
        setExportLinksDisabled(true);
        return false;
      }

      var fromDate = fromResult.date;
      var toDate = toResult.date;
      if (hasBounds) {
        if (!fromDate) {
          fromDate = cloneDate(minBound);
          fromInput.value = formatISODate(fromDate);
        }
        if (!toDate) {
          toDate = cloneDate(maxBound);
          toInput.value = formatISODate(toDate);
        }
      }
      if (fromDate && toDate && dateKey(toDate) < dateKey(fromDate)) {
        if (changedSide == "to") {
          toInput.value = formatISODate(fromDate);
          toDate = fromDate;
        } else {
          fromInput.value = formatISODate(toDate);
          fromDate = toDate;
        }
      }

      fromInput.setCustomValidity("");
      toInput.setCustomValidity("");
      if (fromDate && toDate && dateKey(toDate) < dateKey(fromDate)) {
        toInput.setCustomValidity(invalidRangeMessage);
        setExportLinksDisabled(true);
        return false;
      }
      setExportLinksDisabled(false);
      return true;
    }

    function buildExportEndpoint(baseEndpoint) {
      var url = new URL(baseEndpoint, window.location.origin);
      if (fromInput.value) {
        url.searchParams.set("from", fromInput.value);
      }
      if (toInput.value) {
        url.searchParams.set("to", toInput.value);
      }
      return url.toString();
    }

    function closeCalendar() {
      if (!calendarPanel) return;
      calendarPanel.classList.add("hidden");
      if (calendarJump) {
        calendarJump.classList.add("hidden");
      }
      activeInput = null;
    }

    function toggleCalendarJump() {
      if (!calendarJump) return;
      calendarJump.classList.toggle("hidden");
      if (!calendarJump.classList.contains("hidden") && calendarYear) {
        calendarYear.focus();
      }
    }

    function syncInitialRange() {
      if (!hasBounds) return;

      var fromValue = parseISODate(fromInput.value);
      var toValue = parseISODate(toInput.value);
      fromValue = fromValue || cloneDate(minBound);
      toValue = toValue || cloneDate(maxBound);

      fromInput.value = formatISODate(fromValue);
      toInput.value = formatISODate(toValue);
      validateExportRange("init");
    }

    function renderCalendar() {
      if (!calendarPanel || !calendarTitle || !calendarDays || !activeInput || !visibleMonth) return;
      if (!hasBounds) {
        closeCalendar();
        return;
      }

      visibleMonth = clampMonthToBounds(visibleMonth);
      calendarPanel.classList.remove("hidden");
      calendarTitle.textContent = monthFormatter.format(visibleMonth);
      if (calendarActive) {
        calendarActive.textContent = inputLabel(activeInput);
      }

      renderWeekdayLabels();
      syncJumpControls();
      updateNavButtons();
      calendarDays.innerHTML = "";

      var year = visibleMonth.getFullYear();
      var month = visibleMonth.getMonth();
      var firstWeekday = new Date(year, month, 1).getDay();
      var daysInMonth = new Date(year, month + 1, 0).getDate();
      var selectedDate = parseISODate(activeInput.value);

      for (var blank = 0; blank < firstWeekday; blank++) {
        var placeholder = document.createElement("span");
        placeholder.className = "h-2";
        calendarDays.appendChild(placeholder);
      }

      for (var day = 1; day <= daysInMonth; day++) {
        var dayDate = new Date(year, month, day);
        var button = document.createElement("button");
        button.type = "button";
        button.textContent = String(day);
        button.style.padding = "0.35rem 0";
        button.className = "btn-secondary text-sm";

        var isAllowedDay = isWithinBounds(dayDate);
        if (!isAllowedDay) {
          button.disabled = true;
          button.className = "btn-soft text-sm";
          button.style.opacity = "0.55";
          button.style.cursor = "not-allowed";
        } else {
          (function (selectedDay) {
            button.addEventListener("click", function () {
              if (!activeInput) return;
              activeInput.value = formatISODate(selectedDay);
              validateExportRange(activeInput === toInput ? "to" : "from");
              updatePresetState();
              scheduleSummaryRefresh();
              closeCalendar();
            });
          })(dayDate);
        }

        if (selectedDate && dateKey(selectedDate) === dateKey(dayDate)) {
          button.className = "btn-primary text-sm";
        }

        calendarDays.appendChild(button);
      }
    }

    function openCalendarForInput(input) {
      if (!calendarPanel || !input) return;
      if (!hasBounds) return;
      activeInput = input;
      var selectedValue = parseISODate(input.value);
      var reference = selectedValue || cloneDate(maxBound);
      visibleMonth = clampMonthToBounds(reference);
      renderCalendar();
    }

    function parseFilenameFromDisposition(disposition, fallbackName) {
      if (!disposition) return fallbackName;
      var match = disposition.match(/filename\*?=(?:UTF-8'')?\"?([^\";]+)\"?/i);
      if (!match || !match[1]) return fallbackName;
      try {
        return decodeURIComponent(match[1]);
      } catch (_) {
        return match[1];
      }
    }

    fromInput.title = openCalendarLabel;
    toInput.title = openCalendarLabel;
    if (calendarTitleToggle) {
      calendarTitleToggle.title = jumpTitle;
    }

    if (!hasBounds) {
      fromInput.disabled = true;
      toInput.disabled = true;
      fromInput.value = "";
      toInput.value = "";
      setButtonDisabled(calendarPrev, true);
      setButtonDisabled(calendarNext, true);
      setButtonDisabled(calendarApply, true);
      setButtonDisabled(calendarTitleToggle, true);
      updatePresetState();
      setExportLinksDisabled(false);
    } else {
      syncInitialRange();
      updatePresetState();
      setExportLinksDisabled(false);
      scheduleSummaryRefresh();
    }

    fromInput.addEventListener("input", function () {
      sanitizeDateInputValue(fromInput);
      validateExportRange("from");
      updatePresetState();
      scheduleSummaryRefresh();
    });
    fromInput.addEventListener("blur", function () {
      validateExportRange("from");
      updatePresetState();
      scheduleSummaryRefresh();
    });

    toInput.addEventListener("input", function () {
      sanitizeDateInputValue(toInput);
      validateExportRange("to");
      updatePresetState();
      scheduleSummaryRefresh();
    });
    toInput.addEventListener("blur", function () {
      validateExportRange("to");
      updatePresetState();
      scheduleSummaryRefresh();
    });

    fromInput.addEventListener("focus", function () {
      openCalendarForInput(fromInput);
    });
    fromInput.addEventListener("click", function () {
      openCalendarForInput(fromInput);
    });

    toInput.addEventListener("focus", function () {
      openCalendarForInput(toInput);
    });
    toInput.addEventListener("click", function () {
      openCalendarForInput(toInput);
    });

    for (var presetIndex = 0; presetIndex < presetButtons.length; presetIndex++) {
      (function (button) {
        button.addEventListener("click", function () {
          var presetValue = button.getAttribute("data-export-preset") || "";
          var range = computePresetRange(presetValue);
          if (!range) return;
          fromInput.value = formatISODate(range.from);
          toInput.value = formatISODate(range.to);
          fromInput.dispatchEvent(new Event("input", { bubbles: true }));
          toInput.dispatchEvent(new Event("input", { bubbles: true }));
        });
      })(presetButtons[presetIndex]);
    }

    if (calendarTitleToggle) {
      calendarTitleToggle.addEventListener("click", toggleCalendarJump);
    }

    if (calendarMonth) {
      calendarMonth.addEventListener("change", syncJumpControls);
    }
    if (calendarYear) {
      calendarYear.addEventListener("input", syncJumpControls);
    }

    if (calendarPrev) {
      calendarPrev.addEventListener("click", function () {
        if (!visibleMonth || !activeInput) return;
        var previousMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth() - 1, 1);
        if (hasBounds && !monthIntersectsBounds(previousMonth)) return;
        visibleMonth = previousMonth;
        renderCalendar();
      });
    }

    if (calendarNext) {
      calendarNext.addEventListener("click", function () {
        if (!visibleMonth || !activeInput) return;
        var nextMonth = new Date(visibleMonth.getFullYear(), visibleMonth.getMonth() + 1, 1);
        if (hasBounds && !monthIntersectsBounds(nextMonth)) return;
        visibleMonth = nextMonth;
        renderCalendar();
      });
    }

    if (calendarApply) {
      calendarApply.addEventListener("click", function () {
        if (!calendarMonth || !calendarYear || !activeInput) return;
        var monthValue = Number(calendarMonth.value);
        var yearValue = Number(String(calendarYear.value || "").trim());
        if (Number.isNaN(monthValue) || monthValue < 0 || monthValue > 11) return;
        if (Number.isNaN(yearValue) || yearValue < 1900 || yearValue > 2200) return;
        visibleMonth = clampMonthToBounds(new Date(yearValue, monthValue, 1));
        renderCalendar();
        if (calendarJump) {
          calendarJump.classList.add("hidden");
        }
      });
    }

    if (calendarYear) {
      calendarYear.addEventListener("keydown", function (event) {
        if (event.key === "Enter" && calendarApply) {
          event.preventDefault();
          calendarApply.click();
        }
      });
    }

    if (calendarClose) {
      calendarClose.addEventListener("click", closeCalendar);
    }

    document.addEventListener("click", function (event) {
      if (!calendarPanel || calendarPanel.classList.contains("hidden")) return;
      var target = event.target;
      if (calendarPanel.contains(target)) return;
      if (target === fromInput || target === toInput) return;
      closeCalendar();
    });

    document.addEventListener("keydown", function (event) {
      if (event.key === "Escape") {
        closeCalendar();
      }
    });

    async function handleExport(event) {
      event.preventDefault();
      var link = event.currentTarget;
      var baseEndpoint = link.getAttribute("href");
      if (!baseEndpoint) return;

      if (!validateExportRange("export")) {
        if (fromInput && fromInput.validationMessage) {
          fromInput.reportValidity();
        } else if (toInput) {
          toInput.reportValidity();
        }
        if (typeof window.showToast === "function") {
          var message = invalidRangeMessage;
          if (fromInput && fromInput.validationMessage) {
            message = fromInput.validationMessage;
          } else if (toInput && toInput.validationMessage) {
            message = toInput.validationMessage;
          }
          window.showToast(message, "error");
        }
        return;
      }

      var endpoint = buildExportEndpoint(baseEndpoint);
      var type = (link.getAttribute("data-export-type") || "csv").toLowerCase();

      link.classList.add("btn-loading");
      link.setAttribute("aria-disabled", "true");

      try {
        var headers = {};
        var currentLang = (document.documentElement.getAttribute("lang") || "").trim();
        if (currentLang) {
          headers["Accept-Language"] = currentLang;
        }

        var response = await fetch(endpoint, {
          credentials: "same-origin",
          headers: headers
        });
        if (!response.ok) {
          throw new Error("request_failed");
        }

        var blob = await response.blob();
        var extension = type === "json" ? "json" : "csv";
        var fallbackName = "lume-export." + extension;
        var filename = parseFilenameFromDisposition(response.headers.get("Content-Disposition") || "", fallbackName);

        var objectURL = URL.createObjectURL(blob);
        var downloadLink = document.createElement("a");
        downloadLink.href = objectURL;
        downloadLink.download = filename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        downloadLink.remove();
        window.setTimeout(function () {
          URL.revokeObjectURL(objectURL);
        }, 500);

        if (typeof window.showToast === "function") {
          window.showToast(successMessage, "success");
        }
      } catch (_) {
        if (typeof window.showToast === "function") {
          window.showToast(failedMessage, "error");
        }
      } finally {
        link.classList.remove("btn-loading");
        link.removeAttribute("aria-disabled");
      }
    }

    links.forEach(function (link) {
      link.addEventListener("click", handleExport);
    });
  })();
</script>
{{end}}
{{end}}
