{{define "content"}}
<section class="space-y-6">
  <div>
    <h1 class="journal-title">{{t .Messages "settings.title"}}</h1>
    <p class="journal-muted mt-2">{{t .Messages "settings.subtitle"}}</p>
  </div>

  {{if .SuccessKey}}
  <div class="status-ok flex items-center gap-2"><span aria-hidden="true">âœ…</span><span>{{t .Messages .SuccessKey}}</span></div>
  {{end}}

  {{if or .ErrorKey .ChangePasswordErrorKey}}
  <div class="status-error flex items-center gap-2">
    <span aria-hidden="true">âš ï¸</span>
    <span>{{if .ErrorKey}}{{t .Messages .ErrorKey}}{{else}}{{t .Messages .ChangePasswordErrorKey}}{{end}}</span>
  </div>
  {{end}}

  <section class="journal-card p-5 sm:p-6">
    <h2 class="journal-subtitle">ğŸ‘¤ {{t .Messages "settings.profile.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.profile.subtitle"}}</p>

    <form
      action="/api/settings/profile"
      method="post"
      hx-post="/api/settings/profile"
      hx-target="#settings-profile-status"
      hx-swap="innerHTML"
      class="mt-5 space-y-4"
      data-save-feedback>
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      <label class="field-label" for="settings-display-name">{{t .Messages "settings.profile.display_name"}}</label>
      <input
        id="settings-display-name"
        type="text"
        name="display_name"
        value="{{.CurrentUser.DisplayName}}"
        maxlength="64"
        autocomplete="nickname"
        class="input-field">
      <p class="journal-muted text-xs">{{t .Messages "settings.profile.display_name_hint"}}</p>

      <label class="field-label" for="settings-profile-email">{{t .Messages "settings.profile.email"}}</label>
      <input id="settings-profile-email" type="email" value="{{.CurrentUser.Email}}" readonly class="input-field readonly-field">

      <button type="submit" class="btn-secondary" data-save-button data-saving-label="{{t .Messages "common.saving"}}">{{t .Messages "settings.profile.submit"}}</button>
      <div id="settings-profile-status" class="save-status text-sm"></div>
    </form>
  </section>

  {{if eq .CurrentUser.Role "owner"}}
  <section id="settings-cycle" class="journal-card p-5 sm:p-6" x-data='settingsCycleForm({ cycleLength: {{.CycleLength}}, periodLength: {{.PeriodLength}}, autoPeriodFill: {{if .AutoPeriodFill}}true{{else}}false{{end}} })'>
    <h2 class="journal-subtitle">ğŸ—“ï¸ {{t .Messages "settings.cycle.title"}}</h2>

    <form
      action="/settings/cycle"
      method="post"
      hx-post="/settings/cycle"
      hx-target="#settings-cycle-status"
      hx-swap="innerHTML"
      x-on:submit="if ((cycleLength - periodLength) < 8) { $event.preventDefault() }"
      class="mt-5 space-y-6"
      data-save-feedback>
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      <div class="space-y-2">
        <div class="flex items-center justify-between gap-2">
          <label class="field-label" for="settings-cycle-length">{{t .Messages "settings.cycle.cycle_length"}}</label>
          <span class="journal-muted text-sm"><span x-text="cycleLength">{{.CycleLength}}</span> {{t .Messages "common.days_short"}}</span>
        </div>
        <input
          id="settings-cycle-length"
          type="range"
          min="15"
          max="90"
          name="cycle_length"
          value="{{.CycleLength}}"
          x-model.number="cycleLength"
          class="w-full range-field">
      </div>

      <div class="space-y-2">
        <div class="flex items-center justify-between gap-2">
          <label class="field-label" for="settings-period-length">{{t .Messages "settings.cycle.period_length"}}</label>
          <span class="journal-muted text-sm"><span x-text="periodLength">{{.PeriodLength}}</span> {{t .Messages "common.days_short"}}</span>
        </div>
        <input
          id="settings-period-length"
          type="range"
          min="1"
          max="14"
          name="period_length"
          value="{{.PeriodLength}}"
          x-model.number="periodLength"
          class="w-full range-field">
      </div>

      <div class="space-y-2">
        <label class="field-label" for="settings-last-period-start">{{t .Messages "settings.cycle.last_period_start"}}</label>
        <input
          id="settings-last-period-start"
          type="date"
          name="last_period_start"
          lang="{{.Lang}}"
          aria-label="{{t .Messages "settings.cycle.last_period_start"}}"
          min="{{.CycleStartMinISO}}"
          value="{{.LastPeriodStart}}"
          class="input-field">
        <p class="journal-muted text-xs">{{t .Messages "settings.cycle.last_period_start_hint"}}</p>
      </div>

      <div class="space-y-1">
        <template x-if="(cycleLength - periodLength) < 8">
          <p class="status-error text-sm">{{t .Messages "settings.cycle.error_incompatible"}}</p>
        </template>
        <template x-if="(cycleLength - periodLength) >= 8 && (cycleLength - periodLength) < 15">
          <p class="warning-amber text-sm">{{t .Messages "settings.cycle.warning_approximate"}}</p>
        </template>
        <template x-if="(cycleLength - periodLength) >= 15 && periodLength > 8">
          <p class="journal-muted text-sm">{{t .Messages "settings.cycle.info_period_long"}}</p>
        </template>
        <template x-if="(cycleLength - periodLength) >= 15 && periodLength <= 8 && cycleLength < 24">
          <p class="journal-muted text-sm">{{t .Messages "settings.cycle.info_cycle_short"}}</p>
        </template>
      </div>

      <div class="space-y-2">
        <label class="period-toggle">
          <input type="checkbox" name="auto_period_fill" value="true" x-model="autoPeriodFill" {{if .AutoPeriodFill}}checked{{end}}>
          <span>ğŸ©¸ {{t .Messages "settings.cycle.auto_period_fill"}}</span>
        </label>
        <p class="journal-muted text-sm">{{t .Messages "settings.cycle.auto_period_fill_hint"}}</p>
      </div>

      <div class="flex flex-wrap items-center gap-3">
        <button
          type="submit"
          class="btn-primary"
          :class="{ 'btn--disabled': (cycleLength - periodLength) < 8 }"
          :disabled="(cycleLength - periodLength) < 8"
          data-save-button
          data-saving-label="{{t .Messages "common.saving"}}">{{t .Messages "settings.cycle.save"}}</button>
      </div>
      <div id="settings-cycle-status" class="save-status text-sm"></div>
    </form>
  </section>
  {{end}}

  <section class="journal-card p-5 sm:p-6" id="settings-change-password">
    <h2 class="journal-subtitle">ğŸ”’ {{t .Messages "settings.change_password.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.change_password.subtitle"}}</p>

    <form
      action="/api/settings/change-password"
      method="post"
      hx-post="/api/settings/change-password"
      hx-target="#settings-change-password-status"
      hx-swap="innerHTML"
      class="mt-5 space-y-4"
      data-save-feedback>
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      {{template "password_toggle_field" (dict
        "Messages" .Messages
        "LabelKey" "settings.current_password"
        "FieldID" "settings-current-password"
        "FieldName" "current_password"
        "Autocomplete" "current-password"
        "Required" true)}}

      {{template "password_toggle_field" (dict
        "Messages" .Messages
        "LabelKey" "auth.new_password"
        "FieldID" "settings-new-password"
        "FieldName" "new_password"
        "Autocomplete" "new-password"
        "Required" true)}}

      {{template "password_toggle_field" (dict
        "Messages" .Messages
        "LabelKey" "auth.confirm_password"
        "FieldID" "settings-confirm-password"
        "FieldName" "confirm_password"
        "Autocomplete" "new-password"
        "Required" true)}}
      <p class="journal-muted text-xs">{{t .Messages "auth.password_requirements"}}</p>

      <button type="submit" class="btn-primary" data-save-button data-saving-label="{{t .Messages "common.saving"}}">{{t .Messages "settings.change_password.submit"}}</button>
      <div id="settings-change-password-status" class="save-status text-sm"></div>
    </form>
  </section>

  <section class="journal-card p-5 sm:p-6">
    <h2 class="journal-subtitle">ğŸ”‘ {{t .Messages "settings.recovery_code.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.recovery_code.subtitle"}}</p>

    <form
      action="/api/settings/regenerate-recovery-code"
      method="post"
      class="mt-5"
      data-confirm="{{t .Messages "settings.confirm_regenerate_recovery_code"}}"
      data-confirm-accept="{{t .Messages "settings.recovery_code.submit"}}">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <button type="submit" class="btn-secondary">{{t .Messages "settings.recovery_code.submit"}}</button>
    </form>

    {{if .GeneratedRecoveryCode}}
    <div class="mt-5 space-y-3">
      <p class="field-label">{{t .Messages "settings.recovery_code.generated_title"}}</p>
      <div class="recovery-code-box">{{.GeneratedRecoveryCode}}</div>
      <p class="journal-muted text-xs">{{t .Messages "settings.recovery_code.generated_subtitle"}}</p>
    </div>
    {{end}}
  </section>

  {{if eq .CurrentUser.Role "owner"}}
  <section
    class="journal-card p-5 sm:p-6 space-y-3"
    data-export-section
    data-export-min="{{if .HasExportData}}{{.ExportDateFrom}}{{end}}"
    data-export-max="{{if .HasExportData}}{{.ExportDateTo}}{{end}}"
    data-export-success="{{t .Messages "settings.export_success"}}"
    data-export-failed="{{t .Messages "settings.export_failed"}}"
    data-export-invalid-range="{{t .Messages "settings.export_invalid_range"}}"
    data-export-invalid-date="{{t .Messages "settings.export_invalid_date"}}"
    data-export-open-calendar="{{t .Messages "settings.export_open_calendar"}}"
    data-export-jump-title="{{t .Messages "settings.export_jump_title"}}"
    data-export-summary-total-template="{{t .Messages "settings.export_summary_total"}}"
    data-export-summary-range-template="{{t .Messages "settings.export_summary_range"}}"
    data-export-summary-range-empty="{{t .Messages "settings.export_summary_range_empty"}}">
    <h2 class="journal-subtitle">ğŸ“Š {{t .Messages "settings.export_data"}}</h2>
    <div class="grid gap-3 sm:grid-cols-2">
      <div class="space-y-1">
        <label class="field-label" for="export-from">{{t .Messages "settings.export_from"}}</label>
        <input
          id="export-from"
          type="date"
          autocomplete="off"
          lang="{{.Lang}}"
          aria-label="{{t .Messages "settings.export_from"}}"
          data-export-from
          class="input-field w-full"
          {{if .HasExportData}}value="{{.ExportDateFrom}}"{{end}}>
      </div>
      <div class="space-y-1">
        <label class="field-label" for="export-to">{{t .Messages "settings.export_to"}}</label>
        <input
          id="export-to"
          type="date"
          autocomplete="off"
          lang="{{.Lang}}"
          aria-label="{{t .Messages "settings.export_to"}}"
          data-export-to
          class="input-field w-full"
          {{if .HasExportData}}value="{{.ExportDateTo}}"{{end}}>
      </div>
    </div>
    <div class="flex flex-wrap items-center gap-2" data-export-presets>
      <span class="journal-muted text-sm">{{t .Messages "settings.export_presets"}}:</span>
      <button type="button" class="btn-soft text-sm" data-export-preset="all">{{t .Messages "settings.export_preset_all"}}</button>
      <button type="button" class="btn-soft text-sm" data-export-preset="30">{{t .Messages "settings.export_preset_30"}}</button>
      <button type="button" class="btn-soft text-sm" data-export-preset="90">{{t .Messages "settings.export_preset_90"}}</button>
      <button type="button" class="btn-soft text-sm" data-export-preset="365">{{t .Messages "settings.export_preset_365"}}</button>
    </div>
    <div class="hidden journal-card p-4 space-y-3" data-export-calendar-panel>
      <div class="flex items-center justify-between gap-2">
        <button type="button" class="btn-secondary" data-export-calendar-prev aria-label="{{t .Messages "settings.export_prev_month"}}">â†</button>
        <button
          type="button"
          class="btn-soft text-sm flex-1"
          data-export-calendar-title-toggle
          aria-label="{{t .Messages "settings.export_jump_title"}}">
          <span class="field-label text-center" data-export-calendar-title></span>
        </button>
        <button type="button" class="btn-secondary" data-export-calendar-next aria-label="{{t .Messages "settings.export_next_month"}}">â†’</button>
      </div>
      <div class="hidden flex items-center gap-2" data-export-calendar-jump>
        <select class="input-field w-full" data-export-calendar-month aria-label="{{t .Messages "settings.export_month"}}"></select>
        <input
          type="number"
          class="input-field w-full"
          data-export-calendar-year
          min="1900"
          max="2200"
          step="1"
          aria-label="{{t .Messages "settings.export_year"}}">
        <button type="button" class="btn-secondary" data-export-calendar-apply>{{t .Messages "settings.export_apply"}}</button>
      </div>
      <p class="journal-muted text-sm" data-export-calendar-active></p>
      <div class="grid grid-cols-7 gap-1 text-center text-xs journal-muted" data-export-calendar-weekdays></div>
      <div class="grid grid-cols-7 gap-1" data-export-calendar-days></div>
      <div class="flex justify-end">
        <button type="button" class="btn-secondary" data-export-calendar-close>{{t .Messages "settings.export_close_calendar"}}</button>
      </div>
    </div>
    <div class="flex flex-wrap gap-2">
      <a href="/api/export/csv" data-export-link data-export-type="csv" class="btn-secondary inline-flex items-center justify-center"><span class="mr-2" aria-hidden="true">ğŸ“Š</span><span>{{t .Messages "settings.export_csv"}}</span></a>
      <a href="/api/export/json" data-export-link data-export-type="json" class="btn-secondary inline-flex items-center justify-center"><span class="mr-2" aria-hidden="true">ğŸ§¾</span><span>{{t .Messages "settings.export_json"}}</span></a>
    </div>
    <p class="journal-muted text-sm" data-export-summary-total>{{printf (t .Messages "settings.export_summary_total") .ExportTotalEntries}}</p>
    <p class="journal-muted text-sm" data-export-summary-range>
      {{if .HasExportData}}{{printf (t .Messages "settings.export_summary_range") .ExportDateFromDisplay .ExportDateToDisplay}}{{else}}{{t .Messages "settings.export_summary_range_empty"}}{{end}}
    </p>
    <p class="journal-muted mt-3 text-xs">{{t .Messages "settings.export_data_hint"}}</p>
  </section>
  {{end}}

  {{if eq .CurrentUser.Role "owner"}}
  <section class="journal-card border border-[rgba(196,146,74,0.38)] bg-[rgba(255,247,228,0.62)] p-5 sm:p-6">
    <h2 class="journal-subtitle">ğŸ§¹ {{t .Messages "settings.clear_data.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.clear_data.subtitle"}}</p>

    <form
      action="/api/settings/clear-data"
      method="post"
      class="mt-5"
      data-confirm="{{t .Messages "settings.confirm_clear_data"}}"
      data-confirm-accept="{{t .Messages "settings.clear_data.submit"}}">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <button type="submit" class="btn-warning">{{t .Messages "settings.clear_data.submit"}}</button>
    </form>
  </section>
  {{end}}

  <section class="journal-card border border-red-200 p-5 sm:p-6">
    <h2 class="journal-subtitle text-red-700">âš ï¸ {{t .Messages "settings.danger_zone.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.danger_zone.subtitle"}}</p>

    <form
      hx-delete="/api/settings/delete-account"
      hx-target="#delete-account-feedback"
      hx-swap="innerHTML"
      hx-confirm="{{t .Messages "settings.confirm_delete_account"}}"
      data-confirm-accept="{{t .Messages "settings.delete_account.submit"}}"
      class="mt-5 space-y-4">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      {{template "password_toggle_field" (dict
        "Messages" .Messages
        "LabelKey" "settings.delete_account.password"
        "FieldID" "settings-delete-password"
        "FieldName" "password"
        "Autocomplete" "current-password"
        "Required" true)}}

      <button type="submit" class="btn-danger">{{t .Messages "settings.delete_account.submit"}}</button>
      <div id="delete-account-feedback" class="save-status text-sm"></div>
    </form>
  </section>
</section>
{{if eq .CurrentUser.Role "owner"}}
<script src="/static/js/settings-export.js?v=20260224-4"></script>
{{end}}
{{end}}

