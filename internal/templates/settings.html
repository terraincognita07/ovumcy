{{define "content"}}
<section class="space-y-6">
  <div>
    <h1 class="journal-title">{{t .Messages "settings.title"}}</h1>
    <p class="journal-muted mt-2">{{t .Messages "settings.subtitle"}}</p>
  </div>

  {{if .SuccessKey}}
  <div class="status-ok flex items-center gap-2"><span aria-hidden="true">‚úÖ</span><span>{{t .Messages .SuccessKey}}</span></div>
  {{end}}

  {{if .ErrorKey}}
  <div class="status-error flex items-center gap-2"><span aria-hidden="true">‚ö†Ô∏è</span><span>{{t .Messages .ErrorKey}}</span></div>
  {{end}}

  <section class="journal-card p-5 sm:p-6">
    <h2 class="journal-subtitle">üîí {{t .Messages "settings.change_password.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.change_password.subtitle"}}</p>

    <form action="/api/settings/change-password" method="post" class="mt-5 space-y-4">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      <label class="field-label" for="settings-current-password">{{t .Messages "settings.current_password"}}</label>
      <input id="settings-current-password" type="password" name="current_password" required autocomplete="current-password" class="input-field">

      <label class="field-label" for="settings-new-password">{{t .Messages "auth.new_password"}}</label>
      <input id="settings-new-password" type="password" name="new_password" required autocomplete="new-password" class="input-field">
      <p class="journal-muted text-xs">{{t .Messages "auth.password_requirements"}}</p>

      <button type="submit" class="btn-primary">{{t .Messages "settings.change_password.submit"}}</button>
    </form>
  </section>

  <section class="journal-card p-5 sm:p-6">
    <h2 class="journal-subtitle">üîë {{t .Messages "settings.recovery_code.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.recovery_code.subtitle"}}</p>

    <form
      action="/api/settings/regenerate-recovery-code"
      method="post"
      class="mt-5"
      data-confirm="{{t .Messages "settings.confirm_regenerate_recovery_code"}}"
      data-confirm-accept="{{t .Messages "settings.recovery_code.submit"}}">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <button type="submit" class="btn-secondary">{{t .Messages "settings.recovery_code.submit"}}</button>
    </form>

    {{if .GeneratedRecoveryCode}}
    <div class="mt-5 space-y-3">
      <p class="field-label">{{t .Messages "settings.recovery_code.generated_title"}}</p>
      <div class="recovery-code-box">{{.GeneratedRecoveryCode}}</div>
      <p class="journal-muted text-xs">{{t .Messages "settings.recovery_code.generated_subtitle"}}</p>
    </div>
    {{end}}
  </section>

  {{if eq .CurrentUser.Role "owner"}}
  <section
    class="journal-card p-5 sm:p-6 space-y-3"
    data-export-section
    data-export-success="{{t .Messages "settings.export_success"}}"
    data-export-failed="{{t .Messages "settings.export_failed"}}">
    <h2 class="journal-subtitle">üìä {{t .Messages "settings.export_data"}}</h2>
    <div class="flex flex-wrap gap-2">
      <a href="/api/export/csv" data-export-link class="btn-secondary inline-flex items-center justify-center"><span class="mr-2" aria-hidden="true">üìä</span><span>{{t .Messages "settings.export_csv"}}</span></a>
      <a href="/api/export/json" data-export-link class="btn-secondary inline-flex items-center justify-center"><span class="mr-2" aria-hidden="true">üßæ</span><span>{{t .Messages "settings.export_json"}}</span></a>
    </div>
    <p class="journal-muted text-sm">{{printf (t .Messages "settings.export_summary_total") .ExportTotalEntries}}</p>
    {{if .HasExportData}}
    <p class="journal-muted text-sm">{{printf (t .Messages "settings.export_summary_range") .ExportDateFrom .ExportDateTo}}</p>
    {{else}}
    <p class="journal-muted text-sm">{{t .Messages "settings.export_summary_range_empty"}}</p>
    {{end}}
    <p class="journal-muted mt-3 text-xs">{{t .Messages "settings.export_data_hint"}}</p>
  </section>
  {{end}}

  <section class="journal-card border border-red-200 p-5 sm:p-6">
    <h2 class="journal-subtitle text-red-700">‚ö†Ô∏è {{t .Messages "settings.danger_zone.title"}}</h2>
    <p class="journal-muted mt-2 text-sm">{{t .Messages "settings.danger_zone.subtitle"}}</p>

    <form
      hx-delete="/api/settings/delete-account"
      hx-target="#delete-account-feedback"
      hx-swap="innerHTML"
      hx-confirm="{{t .Messages "settings.confirm_delete_account"}}"
      data-confirm-accept="{{t .Messages "settings.delete_account.submit"}}"
      class="mt-5 space-y-4">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

      <label class="field-label" for="settings-delete-password">{{t .Messages "settings.delete_account.password"}}</label>
      <input id="settings-delete-password" type="password" name="password" required autocomplete="current-password" class="input-field">

      <button type="submit" class="btn-danger">{{t .Messages "settings.delete_account.submit"}}</button>
      <div id="delete-account-feedback" class="save-status text-sm"></div>
    </form>
  </section>
</section>
{{if eq .CurrentUser.Role "owner"}}
<script>
  (function () {
    var section = document.querySelector("[data-export-section]");
    if (!section) return;

    var successMessage = section.getAttribute("data-export-success") || "Data exported successfully";
    var failedMessage = section.getAttribute("data-export-failed") || "Failed to export data";
    var links = section.querySelectorAll("a[data-export-link]");
    if (!links.length) return;

    function parseFilenameFromDisposition(disposition, fallbackName) {
      if (!disposition) return fallbackName;
      var match = disposition.match(/filename\*?=(?:UTF-8'')?\"?([^\";]+)\"?/i);
      if (!match || !match[1]) return fallbackName;
      try {
        return decodeURIComponent(match[1]);
      } catch (_) {
        return match[1];
      }
    }

    async function handleExport(event) {
      event.preventDefault();
      var link = event.currentTarget;
      var endpoint = link.getAttribute("href");
      if (!endpoint) return;

      link.classList.add("btn-loading");
      link.setAttribute("aria-disabled", "true");

      try {
        var response = await fetch(endpoint, { credentials: "same-origin" });
        if (!response.ok) {
          throw new Error("request_failed");
        }

        var blob = await response.blob();
        var extension = endpoint.endsWith("/json") ? "json" : "csv";
        var fallbackName = "lume-export." + extension;
        var filename = parseFilenameFromDisposition(response.headers.get("Content-Disposition") || "", fallbackName);

        var objectURL = URL.createObjectURL(blob);
        var downloadLink = document.createElement("a");
        downloadLink.href = objectURL;
        downloadLink.download = filename;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        downloadLink.remove();
        window.setTimeout(function () {
          URL.revokeObjectURL(objectURL);
        }, 500);

        if (typeof window.showToast === "function") {
          window.showToast(successMessage, "success");
        }
      } catch (_) {
        if (typeof window.showToast === "function") {
          window.showToast(failedMessage, "error");
        }
      } finally {
        link.classList.remove("btn-loading");
        link.removeAttribute("aria-disabled");
      }
    }

    links.forEach(function (link) {
      link.addEventListener("click", handleExport);
    });
  })();
</script>
{{end}}
{{end}}
