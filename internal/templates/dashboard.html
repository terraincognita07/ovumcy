{{define "content"}}
<section class="space-y-6">
  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.current_phase"}}</p>
      {{if .CycleDataStale}}
      <p class="stat-value mt-3"><span class="mr-2">{{phaseIcon "unknown"}}</span>{{phaseLabel .Messages "unknown"}}</p>
      <p class="warning-amber mt-2 text-xs">{{t .Messages "dashboard.phase_estimated"}}</p>
      {{else}}
      <p class="stat-value mt-3"><span class="mr-2">{{phaseIcon .Stats.CurrentPhase}}</span>{{phaseLabel .Messages .Stats.CurrentPhase}}</p>
      {{end}}
    </article>

    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.cycle_day"}}</p>
      <p class="stat-value mt-3">{{if gt .Stats.CurrentCycleDay 0}}{{if .CycleDataStale}}~{{end}}{{.Stats.CurrentCycleDay}}{{else}}{{.NoDataLabel}}{{end}}</p>
      {{if .CycleDataStale}}
      <p class="warning-amber mt-2 text-xs">{{t .Messages "dashboard.cycle_day_stale_hint"}}</p>
      <p class="mt-3"><a href="/settings#settings-cycle" class="btn-secondary text-sm">{{t .Messages "dashboard.update_cycle_data"}}</a></p>
      {{else if .CycleDayWarning}}
      <p class="warning-amber mt-2 text-xs">{{printf (t .Messages "dashboard.cycle_day_long_hint") .CycleDayReference}}</p>
      {{end}}
    </article>

    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.next_period"}}</p>
      <p class="stat-value mt-3">{{if .DisplayNextPeriodStart.IsZero}}{{.NoDataLabel}}{{else}}{{formatLocalizedDate .Lang .DisplayNextPeriodStart "full"}}{{end}}</p>
      {{if .NextPeriodInPast}}
      <p class="warning-amber mt-2 text-xs">{{t .Messages "dashboard.prediction_in_past"}}</p>
      <p class="mt-3"><a href="/settings#settings-cycle" class="btn-secondary text-sm">{{t .Messages "dashboard.update_cycle_data"}}</a></p>
      {{end}}
    </article>

    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.ovulation"}}</p>
      <p class="stat-value mt-3">{{if .DisplayOvulationImpossible}}{{t .Messages "dashboard.ovulation_unavailable"}}{{else if .DisplayOvulationDate.IsZero}}{{.NoDataLabel}}{{else}}{{formatLocalizedDate .Lang .DisplayOvulationDate "full"}}{{end}}</p>
      {{if and (not .DisplayOvulationImpossible) (not .DisplayOvulationDate.IsZero) (not .DisplayOvulationExact)}}
      <p class="journal-muted mt-2 text-xs">{{t .Messages "dashboard.ovulation_approximate"}}</p>
      {{end}}
      {{if .OvulationInPast}}
      <p class="warning-amber mt-2 text-xs">{{t .Messages "dashboard.prediction_in_past"}}</p>
      <p class="mt-3"><a href="/settings#settings-cycle" class="btn-secondary text-sm">{{t .Messages "dashboard.update_cycle_data"}}</a></p>
      {{end}}
    </article>
  </div>

  <div
    class="grid gap-6"
    x-data='dashboardTodayEditor({
      isPeriod: {{if .TodayEntry.IsPeriod}}true{{else}}false{{end}}
    })'>
    <section class="journal-card p-5 sm:p-6">
      <div class="mb-5 flex items-center justify-between gap-3">
        <div>
          <h2 class="journal-subtitle">{{t .Messages "dashboard.today_editor"}}</h2>
          <p class="journal-muted">{{.FormattedDate}}</p>
        </div>
      </div>

      {{if .IsOwner}}
      <form hx-post="/api/days/{{.Today}}" hx-target="#save-status" hx-swap="innerHTML" class="space-y-5" data-save-feedback>
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

        <label class="period-toggle">
          <input type="checkbox" name="is_period" value="true" x-model="isPeriod" {{if .TodayEntry.IsPeriod}}checked{{end}}>
          <span>ðŸ©¸ {{t .Messages "dashboard.period_day"}}</span>
        </label>

        <fieldset class="space-y-3" x-cloak x-show="isPeriod">
          <legend class="field-label">{{t .Messages "dashboard.flow"}}</legend>
          {{template "period_flow_options" (dict "Messages" .Messages "SelectedFlow" .TodayEntry.Flow "Compact" false "DisableWhenNotPeriod" true)}}
        </fieldset>

        <fieldset class="space-y-3">
          <legend class="field-label">{{t .Messages "dashboard.symptoms"}}</legend>
          {{template "symptom_options" (dict "Messages" .Messages "Symptoms" .Symptoms "SelectedSymptomID" .SelectedSymptomID "Lang" .Lang "Compact" false "IncludePreviewHooks" true "DisableWhenNotPeriod" true)}}
        </fieldset>

        <label class="field-label" for="today-notes">{{t .Messages "dashboard.notes"}}</label>
        <textarea id="today-notes" name="notes" rows="4" maxlength="2000" class="textarea-field" x-model="notesPreview">{{.TodayEntry.Notes}}</textarea>

        <div class="flex flex-wrap items-center gap-3">
          <button type="submit" class="btn-primary" data-save-button data-saving-label="{{t .Messages "common.saving"}}">{{t .Messages "dashboard.save_today"}}</button>
          <div id="save-status" class="save-status text-sm"></div>
        </div>

        {{if .TodayHasData}}
        <button
          type="button"
          hx-delete="/api/log/delete?date={{.Today}}&source=dashboard"
          hx-swap="none"
          hx-confirm="{{t .Messages "confirm.delete_entry"}}"
          data-confirm-accept="{{t .Messages "confirm.yes"}}"
          class="btn-danger">
          {{t .Messages "dashboard.clear_today"}}
        </button>
        {{end}}
      </form>
      {{else}}
      {{template "readonly_log_summary" (dict "Messages" .Messages "Log" .TodayEntry)}}
      {{end}}
    </section>

    <section
      class="journal-card p-5 sm:p-6"
      x-cloak
      x-show="isPeriod || hasActiveSymptoms() || hasNotesPreview()"
      x-transition.opacity.duration.220ms>
      <h2 class="journal-subtitle" x-show="isPeriod" x-transition.opacity.duration.220ms>{{t .Messages "dashboard.cycle_snapshot"}}</h2>
      <h2 class="journal-subtitle" x-show="!isPeriod" x-transition.opacity.duration.220ms>{{t .Messages "dashboard.symptoms_notes"}}</h2>

      <dl class="mt-4 space-y-3 text-sm" x-show="isPeriod" x-transition.opacity.duration.220ms>
        <div class="stat-row"><dt>{{t .Messages "dashboard.average_cycle"}}</dt><dd>{{if gt .Stats.AverageCycleLength 0.0}}{{formatFloat .Stats.AverageCycleLength}} {{t .Messages "common.days_short"}}{{else}}{{.NoDataLabel}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.median_cycle"}}</dt><dd>{{if gt .Stats.MedianCycleLength 0}}{{.Stats.MedianCycleLength}} {{t .Messages "common.days_short"}}{{else}}{{.NoDataLabel}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.average_period"}}</dt><dd>{{if gt .Stats.AveragePeriodLength 0.0}}{{formatFloat .Stats.AveragePeriodLength}} {{t .Messages "common.days_short"}}{{else}}{{.NoDataLabel}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.last_period_start"}}</dt><dd>{{if .Stats.LastPeriodStart.IsZero}}{{.NoDataLabel}}{{else}}{{formatLocalizedDate .Lang .Stats.LastPeriodStart "short"}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.fertile_window"}}</dt><dd>{{if .Stats.FertilityWindowStart.IsZero}}{{.NoDataLabel}}{{else}}{{formatLocalizedDate .Lang .Stats.FertilityWindowStart "short"}} - {{formatLocalizedDate .Lang .Stats.FertilityWindowEnd "short"}}{{end}}</dd></div>
      </dl>

      <div class="mt-4 space-y-4 text-sm" x-show="!isPeriod" x-transition.opacity.duration.220ms>
        <div>
          <p class="journal-muted">{{t .Messages "dashboard.symptoms"}}</p>
          <ul class="mt-2 space-y-1" x-show="hasActiveSymptoms()">
            <template x-for="(symptom, index) in activeSymptoms" :key="index">
              <li x-text="symptom"></li>
            </template>
          </ul>
          <p class="mt-2" x-show="!hasActiveSymptoms()">{{.NoDataLabel}}</p>
        </div>

        <div>
          <p class="journal-muted">{{t .Messages "dashboard.notes"}}</p>
          <p class="mt-2 whitespace-pre-wrap break-words" x-show="hasNotesPreview()" x-text="notesPreview"></p>
          <p class="mt-2" x-show="!hasNotesPreview()">{{.NoDataLabel}}</p>
        </div>
      </div>
    </section>
  </div>
</section>
{{end}}
