{{define "content"}}
<section class="space-y-6">
  <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.current_phase"}}</p>
      <p class="stat-value mt-3"><span class="mr-2">{{phaseIcon .Stats.CurrentPhase}}</span>{{phaseLabel .Messages .Stats.CurrentPhase}}</p>
    </article>

    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.cycle_day"}}</p>
      <p class="stat-value mt-3">{{if gt .Stats.CurrentCycleDay 0}}{{.Stats.CurrentCycleDay}}{{else}}{{.NoDataLabel}}{{end}}</p>
    </article>

    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.next_period"}}</p>
      <p class="stat-value mt-3">{{if .Stats.NextPeriodStart.IsZero}}{{.NoDataLabel}}{{else}}{{formatDate .Stats.NextPeriodStart "02.01.2006"}}{{end}}</p>
    </article>

    <article class="journal-card stat-card reveal">
      <p class="stat-label">{{t .Messages "dashboard.ovulation"}}</p>
      <p class="stat-value mt-3">{{if .Stats.OvulationDate.IsZero}}{{.NoDataLabel}}{{else}}{{formatDate .Stats.OvulationDate "02.01.2006"}}{{end}}</p>
    </article>
  </div>

  <div
    class="grid gap-6 lg:grid-cols-[1.55fr_1fr]"
    x-data="{
      isPeriod: {{if .TodayLog.IsPeriod}}true{{else}}false{{end}},
      activeSymptoms: [],
      notesPreview: '',
      syncSymptoms() {
        this.activeSymptoms = Array.from(this.$root.querySelectorAll(`input[name='symptom_ids']:checked`))
          .map((input) => (input.dataset.symptomLabel || '').trim())
          .filter((label) => label.length > 0);
      },
      init() {
        const notesField = this.$root.querySelector('#today-notes');
        this.notesPreview = notesField ? notesField.value : '';
        this.syncSymptoms();
      }
    }">
    <section class="journal-card p-5 sm:p-6">
      <div class="mb-5 flex items-center justify-between gap-3">
        <div>
          <h2 class="journal-subtitle">{{t .Messages "dashboard.today_editor"}}</h2>
          <p class="journal-muted">{{.FormattedDate}}</p>
        </div>
      </div>

      {{if .IsOwner}}
      <form hx-post="/api/days/{{.Today}}" hx-target="#save-status" hx-swap="innerHTML" class="space-y-5" data-save-feedback>
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

        <label class="period-toggle">
          <input type="checkbox" name="is_period" value="true" x-model="isPeriod" {{if .TodayLog.IsPeriod}}checked{{end}}>
          <span>ü©∏ {{t .Messages "dashboard.period_day"}}</span>
        </label>

        <fieldset class="space-y-3" x-cloak x-show="isPeriod">
          <legend class="field-label">{{t .Messages "dashboard.flow"}}</legend>
          <div class="grid gap-2 sm:grid-cols-4">
            <label class="choice-option">
              <input type="radio" name="flow" value="none" class="choice-input" :disabled="!isPeriod" {{if eq .TodayLog.Flow "none"}}checked{{end}}>
              <span class="radio-tile"><span class="radio-icon">üå´Ô∏è</span><span>{{flowLabel .Messages "none"}}</span></span>
            </label>
            <label class="choice-option">
              <input type="radio" name="flow" value="light" class="choice-input" :disabled="!isPeriod" {{if eq .TodayLog.Flow "light"}}checked{{end}}>
              <span class="radio-tile"><span class="radio-icon">üå∑</span><span>{{flowLabel .Messages "light"}}</span></span>
            </label>
            <label class="choice-option">
              <input type="radio" name="flow" value="medium" class="choice-input" :disabled="!isPeriod" {{if eq .TodayLog.Flow "medium"}}checked{{end}}>
              <span class="radio-tile"><span class="radio-icon">üå∫</span><span>{{flowLabel .Messages "medium"}}</span></span>
            </label>
            <label class="choice-option">
              <input type="radio" name="flow" value="heavy" class="choice-input" :disabled="!isPeriod" {{if eq .TodayLog.Flow "heavy"}}checked{{end}}>
              <span class="radio-tile"><span class="radio-icon">üî•</span><span>{{flowLabel .Messages "heavy"}}</span></span>
            </label>
          </div>
        </fieldset>

        <fieldset class="space-y-3">
          <legend class="field-label">{{t .Messages "dashboard.symptoms"}}</legend>
          <div class="symptom-grid">
            {{range .Symptoms}}
            <label class="choice-option">
              <input
                type="checkbox"
                name="symptom_ids"
                value="{{.ID}}"
                class="choice-input"
                data-symptom-label="{{symptomLabel $.Messages .Name}}"
                @change="syncSymptoms"
                {{if hasSymptom $.SelectedSymptomID .ID}}checked{{end}}>
              <span class="check-chip">
                <span class="symptom-icon">{{.Icon}}</span>
                <span class="symptom-label">{{symptomLabel $.Messages .Name}}</span>
              </span>
            </label>
            {{end}}
          </div>
        </fieldset>

        <label class="field-label" for="today-notes">{{t .Messages "dashboard.notes"}}</label>
        <textarea id="today-notes" name="notes" rows="4" maxlength="2000" class="textarea-field" x-model="notesPreview">{{.TodayLog.Notes}}</textarea>

        <div class="flex flex-wrap items-center gap-3">
          <button type="submit" class="btn-primary" data-save-button data-saving-label="{{t .Messages "common.saving"}}">{{t .Messages "dashboard.save_today"}}</button>
          <div id="save-status" class="save-status text-sm"></div>
        </div>

        {{if .TodayHasData}}
        <button
          type="button"
          hx-delete="/api/log/delete?date={{.Today}}&source=dashboard"
          hx-swap="none"
          hx-confirm="{{t .Messages "confirm.delete_entry"}}"
          data-confirm-accept="{{t .Messages "confirm.yes"}}"
          class="btn-danger">
          {{t .Messages "dashboard.clear_today"}}
        </button>
        {{end}}
      </form>
      {{else}}
      <div class="journal-panel space-y-3 text-sm">
        <p><span class="journal-muted">{{t .Messages "dashboard.period_day"}}:</span> {{if .TodayLog.IsPeriod}}{{t .Messages "common.yes"}}{{else}}{{t .Messages "common.no"}}{{end}}</p>
        <p><span class="journal-muted">{{t .Messages "dashboard.flow"}}:</span> {{flowLabel .Messages .TodayLog.Flow}}</p>
        <p class="journal-muted">{{t .Messages "dashboard.partner_readonly"}}</p>
      </div>
      {{end}}
    </section>

    <section class="journal-card p-5 sm:p-6">
      <h2 class="journal-subtitle" x-show="isPeriod">{{t .Messages "dashboard.cycle_snapshot"}}</h2>
      <h2 class="journal-subtitle" x-cloak x-show="!isPeriod">{{t .Messages "dashboard.symptoms_notes"}}</h2>

      <dl class="mt-4 space-y-3 text-sm" x-show="isPeriod">
        <div class="stat-row"><dt>{{t .Messages "dashboard.average_cycle"}}</dt><dd>{{if gt .Stats.AverageCycleLength 0.0}}{{formatFloat .Stats.AverageCycleLength}} {{t .Messages "common.days_short"}}{{else}}{{.NoDataLabel}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.median_cycle"}}</dt><dd>{{if gt .Stats.MedianCycleLength 0}}{{.Stats.MedianCycleLength}} {{t .Messages "common.days_short"}}{{else}}{{.NoDataLabel}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.average_period"}}</dt><dd>{{if gt .Stats.AveragePeriodLength 0.0}}{{formatFloat .Stats.AveragePeriodLength}} {{t .Messages "common.days_short"}}{{else}}{{.NoDataLabel}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.last_period_start"}}</dt><dd>{{if .Stats.LastPeriodStart.IsZero}}{{.NoDataLabel}}{{else}}{{formatDate .Stats.LastPeriodStart "02.01"}}{{end}}</dd></div>
        <div class="stat-row"><dt>{{t .Messages "dashboard.fertile_window"}}</dt><dd>{{if .Stats.FertilityWindowStart.IsZero}}{{.NoDataLabel}}{{else}}{{formatDate .Stats.FertilityWindowStart "02.01"}} - {{formatDate .Stats.FertilityWindowEnd "02.01"}}{{end}}</dd></div>
      </dl>

      <div class="mt-4 space-y-4 text-sm" x-cloak x-show="!isPeriod">
        <div>
          <p class="journal-muted">{{t .Messages "dashboard.symptoms"}}</p>
          <ul class="mt-2 space-y-1" x-show="activeSymptoms.length > 0">
            <template x-for="(symptom, index) in activeSymptoms" :key="index">
              <li x-text="symptom"></li>
            </template>
          </ul>
          <p class="mt-2" x-show="activeSymptoms.length === 0">{{.NoDataLabel}}</p>
        </div>

        <div>
          <p class="journal-muted">{{t .Messages "dashboard.notes"}}</p>
          <p class="mt-2 whitespace-pre-wrap break-words" x-show="notesPreview.trim().length > 0" x-text="notesPreview"></p>
          <p class="mt-2" x-show="notesPreview.trim().length === 0">{{.NoDataLabel}}</p>
        </div>
      </div>
    </section>
  </div>
</section>
{{end}}
