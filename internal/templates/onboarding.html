{{define "content"}}
<section
  class="mx-auto max-w-4xl"
  x-data='onboardingFlow({
    minDate: "{{.MinDate}}",
    maxDate: "{{.MaxDate}}",
    lastPeriodStart: "{{.LastPeriodStart}}",
    initialStep: {{.OnboardingStep}},
    cycleLength: {{.CycleLength}},
    periodLength: {{.PeriodLength}},
    autoPeriodFill: {{if .AutoPeriodFill}}true{{else}}false{{end}},
    periodExceedsCycleMessage: "{{t .Messages "onboarding.step2.error_incompatible"}}",
    lang: "{{.Lang}}"
  })'
>
  <div class="journal-card journal-hero p-6 sm:p-8">
    <div class="space-y-3" x-show="step > 0" x-transition>
      <p class="journal-kicker" x-show="step === 1">{{t .Messages "onboarding.progress.step1"}}</p>
      <p class="journal-kicker" x-show="step === 2">{{t .Messages "onboarding.progress.step2"}}</p>
      <p class="journal-kicker" x-show="step === 3">{{t .Messages "onboarding.progress.step3"}}</p>

      <div class="journal-panel space-y-2">
        <div class="h-2 overflow-hidden rounded-full bg-[rgba(232,196,168,0.35)]">
          <div
            class="h-full rounded-full transition-all duration-300"
            :style="`width: ${(step / 3) * 100}%; background: linear-gradient(135deg, #D4A574, #E8C4A8);`"></div>
        </div>
      </div>
    </div>

    <div x-show="step === 0" x-transition class="mt-2 space-y-5">
      <p class="journal-kicker">{{t .Messages "onboarding.welcome.kicker"}}</p>
      <h1 class="journal-title">{{t .Messages "onboarding.welcome.title"}}</h1>
      <p class="journal-muted">{{t .Messages "onboarding.welcome.subtitle"}}</p>

      <div class="journal-panel">
        <p class="journal-muted text-sm">{{t .Messages "onboarding.welcome.details"}}</p>
      </div>

      <button type="button" class="btn-primary" @click="begin()">{{t .Messages "onboarding.button.begin"}}</button>
    </div>

    <div x-show="step === 1" x-transition class="mt-6 space-y-4">
      <h1 class="journal-title">{{t .Messages "onboarding.step1.title"}}</h1>
      <p class="journal-muted">{{t .Messages "onboarding.step1.subtitle"}}</p>

      <form
        hx-post="/onboarding/step1"
        hx-target="#onboarding-step1-status"
        hx-swap="innerHTML"
        x-on:htmx:after-request="onStepOneSaved($event)"
        class="space-y-4">
      <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
      <input type="hidden" name="last_period_start" :value="selectedDate">

        <label class="field-label" for="last-period-start">{{t .Messages "onboarding.step1.field"}}</label>
        <input
          id="last-period-start"
          type="date"
          class="input-field"
          lang="{{.Lang}}"
          placeholder="{{t .Messages "onboarding.step1.date_placeholder"}}"
          x-model="selectedDate"
          @change="onStartDateChanged"
          min="{{.MinDate}}"
          max="{{.MaxDate}}">

        <div class="grid max-h-72 grid-cols-3 gap-2 overflow-y-auto pr-1 sm:grid-cols-4 lg:grid-cols-6">
          <template x-for="day in dayOptions" :key="day.value">
            <button
              type="button"
              class="check-chip check-chip-sm justify-center"
              :class="{ 'choice-chip-active': selectedDate === day.value }"
              @click="setStartDate(day.value)"
              x-text="day.label"></button>
          </template>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <button type="button" class="btn-secondary" @click="goToStep(0)">{{t .Messages "onboarding.button.back"}}</button>
          <button type="submit" class="btn-primary">{{t .Messages "onboarding.button.next"}}</button>
        </div>
        <div id="onboarding-step1-status" class="save-status text-sm"></div>
      </form>
    </div>

    <div x-show="step === 2" x-transition class="mt-6 space-y-4">
      <h1 class="journal-title">{{t .Messages "onboarding.step2.title"}}</h1>

      <form
        hx-post="/onboarding/step2"
        hx-target="#onboarding-step2-status"
        hx-swap="innerHTML"
        x-on:submit="if (!validateStepTwoBeforeSubmit($event)) { $event.preventDefault() }"
        x-on:htmx:after-request="onStepTwoSaved($event)"
        class="space-y-6">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

        <div class="space-y-2">
          <div class="flex items-center justify-between gap-2">
            <label class="field-label" for="cycle-length">{{t .Messages "onboarding.step2.cycle_length"}}</label>
            <span class="journal-muted text-sm"><span x-text="cycleLength">{{.CycleLength}}</span> {{t .Messages "common.days_short"}}</span>
          </div>
          <input
            id="cycle-length"
            type="range"
            min="15"
            max="90"
            name="cycle_length"
            value="{{.CycleLength}}"
            x-model.number="cycleLength"
            @input="onCycleLengthChanged()"
            class="w-full range-field">
        </div>

        <div class="space-y-2">
          <div class="flex items-center justify-between gap-2">
            <label class="field-label" for="period-length">{{t .Messages "onboarding.step2.period_length"}}</label>
            <span class="journal-muted text-sm"><span x-text="periodLength">{{.PeriodLength}}</span> {{t .Messages "common.days_short"}}</span>
          </div>
          <input
            id="period-length"
            type="range"
            min="1"
            max="14"
            name="period_length"
            value="{{.PeriodLength}}"
            x-model.number="periodLength"
            @input="onPeriodLengthChanged()"
            class="w-full range-field">
        </div>

        <div class="space-y-1">
          <p class="status-error text-sm" x-cloak x-show="(cycleLength - periodLength) < 8">{{t .Messages "onboarding.step2.error_incompatible"}}</p>
          <p class="warning-amber text-sm" x-cloak x-show="(cycleLength - periodLength) >= 8 && (cycleLength - periodLength) < 15">{{t .Messages "onboarding.step2.warning_approximate"}}</p>
          <p class="journal-muted text-sm" x-cloak x-show="(cycleLength - periodLength) >= 15 && periodLength > 8">{{t .Messages "onboarding.step2.info_period_long"}}</p>
          <p class="journal-muted text-sm" x-cloak x-show="(cycleLength - periodLength) >= 15 && periodLength <= 8 && cycleLength < 24">{{t .Messages "onboarding.step2.info_cycle_short"}}</p>
        </div>

        <div class="space-y-2">
          <label class="period-toggle">
            <input type="checkbox" name="auto_period_fill" value="true" x-model="autoPeriodFill" {{if .AutoPeriodFill}}checked{{end}}>
            <span>ðŸ©¸ {{t .Messages "onboarding.step2.auto_period_fill"}}</span>
          </label>
          <p class="journal-muted text-sm">{{t .Messages "onboarding.step2.auto_period_fill_hint"}}</p>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <button type="button" class="btn-secondary" @click="goToStep(1)">{{t .Messages "onboarding.button.back"}}</button>
          <button
            type="submit"
            class="btn-primary"
            :class="{ 'btn--disabled': (cycleLength - periodLength) < 8 }"
            :disabled="(cycleLength - periodLength) < 8">{{t .Messages "onboarding.button.next"}}</button>
        </div>
        <div id="onboarding-step2-status" class="save-status text-sm"></div>
      </form>
    </div>

    <div x-show="step === 3" x-transition class="mt-6 space-y-4">
      <h1 class="journal-title">{{t .Messages "onboarding.step3.title"}}</h1>
      <p class="journal-muted">{{t .Messages "onboarding.step3.message"}}</p>

      <form hx-post="/onboarding/complete" hx-target="#onboarding-step3-status" hx-swap="innerHTML">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <div class="flex flex-wrap items-center gap-3">
          <button type="button" class="btn-secondary" @click="goToStep(2)">{{t .Messages "onboarding.button.back"}}</button>
          <button type="submit" class="btn-primary">{{t .Messages "onboarding.button.start"}}</button>
        </div>
        <div id="onboarding-step3-status" class="save-status mt-3 text-sm"></div>
      </form>
    </div>
  </div>
</section>

{{end}}
